{% extends "base.html" %} {% block title %}Gestion des Fournisseurs{% endblock
%} {% block content %}
<div class="container-fluid">
    <!-- En-t√™te -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-truck text-warning"></i>
                        Gestion des Fournisseurs
                    </h1>
                    <p class="text-muted mb-0">
                        G√©rer les fournisseurs et leurs informations
                    </p>
                </div>
                <div class="btn-group">
                    <button
                        class="btn btn-info btn-sm"
                        id="btnSynchroniser"
                        title="Synchroniser les relations fournisseurs"
                    >
                        <i class="bi bi-arrow-repeat"></i> Synchroniser
                    </button>
                    <button
                        class="btn btn-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#nouveauFournisseurModal"
                    >
                        <i class="bi bi-plus-circle"></i> Nouveau Fournisseur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        {{ fournisseurs|length }}
                    </h5>
                    <p class="card-text">Total Fournisseurs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-success">
                        {{ fournisseurs|selectattr('statut', 'equalto',
                        'Actif')|list|length }}
                    </h5>
                    <p class="card-text">Fournisseurs Actifs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-danger">
                        {{ fournisseurs|selectattr('statut', 'equalto',
                        'Inactif')|list|length }}
                    </h5>
                    <p class="card-text">Fournisseurs Inactifs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">
                        {{ fournisseurs|selectattr('type', 'equalto',
                        'Principal')|list|length }}
                    </h5>
                    <p class="card-text">Fournisseurs Principaux</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et recherche -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Rechercher</label>
                            <input
                                type="text"
                                class="form-control"
                                id="searchInput"
                                placeholder="Nom, email, t√©l√©phone..."
                            />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Statut</label>
                            <select class="form-select" id="statutFilter">
                                <option value="">Tous les statuts</option>
                                <option value="Actif">Actif</option>
                                <option value="Inactif">Inactif</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="typeFilter">
                                <option value="">Tous les types</option>
                                <option value="Principal">Principal</option>
                                <option value="Secondaire">Secondaire</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des fournisseurs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table"></i> Liste des Fournisseurs
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table
                            class="table table-hover mb-0"
                            id="fournisseursTable"
                        >
                            <thead class="table-light">
                                <tr>
                                    <th>Nom</th>
                                    <th>Adresse</th>
                                    <th>Contact 1</th>
                                    <th>Contact 2</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fournisseur in fournisseurs %}
                                <tr
                                    data-statut="{{ fournisseur.statut or 'Actif' }}"
                                    data-type="Principal"
                                    data-id="{{ fournisseur.id }}"
                                >
                                    <td>
                                        <strong
                                            >{{ fournisseur.nom_fournisseur
                                            }}</strong
                                        >
                                    </td>
                                    <td>{{ fournisseur.adresse or '-' }}</td>
                                    <td>
                                        {% if fournisseur.contact1_nom or
                                        fournisseur.contact1_prenom %}
                                        <div class="small">
                                            <strong
                                                >{{ fournisseur.contact1_nom }}
                                                {{ fournisseur.contact1_prenom
                                                }}</strong
                                            ><br />
                                            {% if fournisseur.contact1_fonction
                                            %}<em
                                                >{{
                                                fournisseur.contact1_fonction
                                                }}</em
                                            ><br />{% endif %} {% if
                                            fournisseur.contact1_tel_fixe %}üìû
                                            {{ fournisseur.contact1_tel_fixe
                                            }}<br />{% endif %} {% if
                                            fournisseur.contact1_tel_mobile %}üì±
                                            {{ fournisseur.contact1_tel_mobile
                                            }}<br />{% endif %} {% if
                                            fournisseur.contact1_email %}‚úâÔ∏è {{
                                            fournisseur.contact1_email }}{%
                                            endif %}
                                        </div>
                                        {% else %} - {% endif %}
                                    </td>
                                    <td>
                                        {% if fournisseur.contact2_nom or
                                        fournisseur.contact2_prenom %}
                                        <div class="small">
                                            <strong
                                                >{{ fournisseur.contact2_nom }}
                                                {{ fournisseur.contact2_prenom
                                                }}</strong
                                            ><br />
                                            {% if fournisseur.contact2_fonction
                                            %}<em
                                                >{{
                                                fournisseur.contact2_fonction
                                                }}</em
                                            ><br />{% endif %} {% if
                                            fournisseur.contact2_tel_fixe %}üìû
                                            {{ fournisseur.contact2_tel_fixe
                                            }}<br />{% endif %} {% if
                                            fournisseur.contact2_tel_mobile %}üì±
                                            {{ fournisseur.contact2_tel_mobile
                                            }}<br />{% endif %} {% if
                                            fournisseur.contact2_email %}‚úâÔ∏è {{
                                            fournisseur.contact2_email }}{%
                                            endif %}
                                        </div>
                                        {% else %} - {% endif %}
                                    </td>
                                    <td>
                                        <span
                                            class="badge bg-{{ 'success' if fournisseur.statut != 'Inactif' else 'danger' }}"
                                        >
                                            {{ fournisseur.statut or 'Actif' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button
                                                class="btn btn-outline-info"
                                                onclick="voirDetailsFournisseur('{{ fournisseur.nom_fournisseur }}')"
                                                title="Voir d√©tails"
                                            >
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button
                                                class="btn btn-outline-warning"
                                                onclick="modifierFournisseur({{ fournisseur.id }})"
                                                title="Modifier"
                                            >
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button
                                                class="btn btn-outline-danger"
                                                onclick="supprimerFournisseur({{ fournisseur.id }}, '{{ fournisseur.nom_fournisseur }}')"
                                                title="Supprimer"
                                            >
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouveau Fournisseur -->
<div class="modal fade" id="nouveauFournisseurModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle text-warning"></i>
                    Nouveau Fournisseur
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="nouveauFournisseurForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Informations g√©n√©rales -->
                        <div class="col-12">
                            <h6 class="text-warning">
                                <i class="bi bi-building"></i> Informations
                                g√©n√©rales
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"
                                >Nom du fournisseur *</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                name="nom_fournisseur"
                                required
                                placeholder="Nom du fournisseur"
                            />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Statut</label>
                            <select class="form-select" name="statut">
                                <option value="Actif">Actif</option>
                                <option value="Inactif">Inactif</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Adresse</label>
                            <textarea
                                class="form-control"
                                name="adresse"
                                rows="2"
                                placeholder="Adresse compl√®te du fournisseur"
                            ></textarea>
                        </div>

                        <!-- Contact 1 -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary">
                                <i class="bi bi-person"></i> Contact 1
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Nom</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact1_nom"
                                placeholder="Nom"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Pr√©nom</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact1_prenom"
                                placeholder="Pr√©nom"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fonction</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact1_fonction"
                                placeholder="Fonction"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone fixe</label>
                            <input
                                type="tel"
                                class="form-control"
                                name="contact1_tel_fixe"
                                placeholder="01 23 45 67 89"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone mobile</label>
                            <input
                                type="tel"
                                class="form-control"
                                name="contact1_tel_mobile"
                                placeholder="06 12 34 56 78"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <input
                                type="email"
                                class="form-control"
                                name="contact1_email"
                                placeholder="email@exemple.com"
                            />
                        </div>

                        <!-- Contact 2 -->
                        <div class="col-12 mt-4">
                            <h6 class="text-info">
                                <i class="bi bi-person"></i> Contact 2
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Nom</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact2_nom"
                                placeholder="Nom"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Pr√©nom</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact2_prenom"
                                placeholder="Pr√©nom"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fonction</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact2_fonction"
                                placeholder="Fonction"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone fixe</label>
                            <input
                                type="tel"
                                class="form-control"
                                name="contact2_tel_fixe"
                                placeholder="01 23 45 67 89"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone mobile</label>
                            <input
                                type="tel"
                                class="form-control"
                                name="contact2_tel_mobile"
                                placeholder="06 12 34 56 78"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <input
                                type="email"
                                class="form-control"
                                name="contact2_email"
                                placeholder="email@exemple.com"
                            />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Cr√©er le fournisseur
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modifier Fournisseur -->
<div class="modal fade" id="modifierFournisseurModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil text-warning"></i>
                    Modifier Fournisseur
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="modifierFournisseurForm">
                <div class="modal-body">
                    <input type="hidden" name="id" id="modifId" />
                    <div class="row g-3">
                        <!-- Informations g√©n√©rales -->
                        <div class="col-12">
                            <h6 class="text-warning">
                                <i class="bi bi-building"></i> Informations
                                g√©n√©rales
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"
                                >Nom du fournisseur *</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                name="nom_fournisseur"
                                id="modifNomFournisseur"
                                required
                            />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Statut</label>
                            <select
                                class="form-select"
                                name="statut"
                                id="modifStatut"
                            >
                                <option value="Actif">Actif</option>
                                <option value="Inactif">Inactif</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Adresse</label>
                            <textarea
                                class="form-control"
                                name="adresse"
                                id="modifAdresse"
                                rows="2"
                            ></textarea>
                        </div>

                        <!-- Contact 1 -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary">
                                <i class="bi bi-person"></i> Contact 1
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Nom</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact1_nom"
                                id="modifContact1Nom"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Pr√©nom</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact1_prenom"
                                id="modifContact1Prenom"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fonction</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact1_fonction"
                                id="modifContact1Fonction"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone fixe</label>
                            <input
                                type="tel"
                                class="form-control"
                                name="contact1_tel_fixe"
                                id="modifContact1TelFixe"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone mobile</label>
                            <input
                                type="tel"
                                class="form-control"
                                name="contact1_tel_mobile"
                                id="modifContact1TelMobile"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <input
                                type="email"
                                class="form-control"
                                name="contact1_email"
                                id="modifContact1Email"
                            />
                        </div>

                        <!-- Contact 2 -->
                        <div class="col-12 mt-4">
                            <h6 class="text-info">
                                <i class="bi bi-person"></i> Contact 2
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Nom</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact2_nom"
                                id="modifContact2Nom"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Pr√©nom</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact2_prenom"
                                id="modifContact2Prenom"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fonction</label>
                            <input
                                type="text"
                                class="form-control"
                                name="contact2_fonction"
                                id="modifContact2Fonction"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone fixe</label>
                            <input
                                type="tel"
                                class="form-control"
                                name="contact2_tel_fixe"
                                id="modifContact2TelFixe"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone mobile</label>
                            <input
                                type="tel"
                                class="form-control"
                                name="contact2_tel_mobile"
                                id="modifContact2TelMobile"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <input
                                type="email"
                                class="form-control"
                                name="contact2_email"
                                id="modifContact2Email"
                            />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Modifier le
                        fournisseur
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Confirmer Suppression -->
<div class="modal fade" id="confirmerSuppressionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger"></i>
                    Confirmer la Suppression
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir supprimer ce fournisseur ?</p>
                <div class="alert alert-warning">
                    <strong id="fournisseur_nom_suppression"></strong>
                </div>
                <p class="text-danger">
                    <strong>Cette action est irr√©versible.</strong>
                </p>
                <p class="text-muted">
                    <small
                        >Note: Les produits associ√©s √† ce fournisseur ne seront
                        pas supprim√©s, mais leur r√©f√©rence fournisseur sera
                        conserv√©e.</small
                    >
                </p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Annuler
                </button>
                <button
                    type="button"
                    id="confirmerSuppression"
                    class="btn btn-danger"
                >
                    <i class="bi bi-trash"></i> Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // D√©clarer la variable globalement pour qu'elle soit accessible partout
    let fournisseurIdASupprimer = null;

    document.addEventListener("DOMContentLoaded", function () {
        // Recherche et filtres
        const searchInput = document.getElementById("searchInput");
        const statutFilter = document.getElementById("statutFilter");
        const typeFilter = document.getElementById("typeFilter");
        const table = document.getElementById("fournisseursTable");
        const rows = table.querySelectorAll("tbody tr");

        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const statutValue = statutFilter.value;
            const typeValue = typeFilter.value;

            rows.forEach((row) => {
                const nom = row.cells[0].textContent.toLowerCase();
                const adresse = row.cells[1].textContent.toLowerCase();
                const contact1 = row.cells[2].textContent.toLowerCase();
                const contact2 = row.cells[3].textContent.toLowerCase();
                const statut = row.dataset.statut;
                const type = row.dataset.type;

                const matchSearch =
                    !searchTerm ||
                    nom.includes(searchTerm) ||
                    adresse.includes(searchTerm) ||
                    contact1.includes(searchTerm) ||
                    contact2.includes(searchTerm);

                const matchStatut = !statutValue || statut === statutValue;
                const matchType = !typeValue || type === typeValue;

                if (matchSearch && matchStatut && matchType) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        searchInput.addEventListener("input", filterTable);
        statutFilter.addEventListener("change", filterTable);
        typeFilter.addEventListener("change", filterTable);

        // Gestion du bouton de synchronisation
        document
            .getElementById("btnSynchroniser")
            .addEventListener("click", function () {
                const btn = this;
                const originalText = btn.innerHTML;

                // D√©sactiver le bouton et changer le texte
                btn.disabled = true;
                btn.innerHTML =
                    '<i class="bi bi-hourglass-split"></i> Synchronisation...';

                fetch("/api/synchroniser-fournisseurs", {
                    method: "POST",
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // Afficher un message de succ√®s
                            const alertDiv = document.createElement("div");
                            alertDiv.className =
                                "alert alert-success alert-dismissible fade show";
                            alertDiv.innerHTML = `
                        <i class="bi bi-check-circle"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                            // Ins√©rer l'alerte en haut de la page
                            const container =
                                document.querySelector(".container-fluid");
                            container.insertBefore(
                                alertDiv,
                                container.firstChild
                            );

                            // Recharger la page apr√®s un d√©lai si des liens ont √©t√© cr√©√©s
                            if (data.liens_crees > 0) {
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            }
                        } else {
                            throw new Error(
                                data.message ||
                                    "Erreur lors de la synchronisation"
                            );
                        }
                    })
                    .catch((error) => {
                        console.error("Erreur:", error);
                        alert(
                            "Erreur lors de la synchronisation: " +
                                error.message
                        );
                    })
                    .finally(() => {
                        // R√©activer le bouton
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    });
            });

        // Formulaire nouveau fournisseur
        document
            .getElementById("nouveauFournisseurForm")
            .addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());

                // Validation
                if (!data.nom_fournisseur) {
                    alert("Veuillez remplir le nom du fournisseur");
                    return;
                }

                // G√©n√©rer un ID fournisseur unique
                const timestamp = new Date()
                    .toISOString()
                    .replace(/[-:T]/g, "")
                    .slice(0, 14);
                data.id_fournisseur = `F${timestamp}`;

                // Appel API pour cr√©er le fournisseur
                fetch("/fournisseurs/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                })
                    .then((response) => response.json())
                    .then((result) => {
                        if (result.id || result.nom_fournisseur) {
                            // Afficher un message de succ√®s
                            const alertDiv = document.createElement("div");
                            alertDiv.className =
                                "alert alert-success alert-dismissible fade show";
                            alertDiv.innerHTML = `
                                <i class="bi bi-check-circle"></i> Fournisseur cr√©√© avec succ√®s
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;

                            // Ins√©rer l'alerte en haut de la page
                            const container =
                                document.querySelector(".container-fluid");
                            container.insertBefore(
                                alertDiv,
                                container.firstChild
                            );

                            bootstrap.Modal.getInstance(
                                document.getElementById(
                                    "nouveauFournisseurModal"
                                )
                            ).hide();

                            // Recharger la page apr√®s un d√©lai
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            throw new Error(
                                result.detail ||
                                    result.message ||
                                    "Erreur inconnue"
                            );
                        }
                    })
                    .catch((error) => {
                        console.error("Erreur:", error);
                        alert(
                            "Erreur lors de la cr√©ation du fournisseur: " +
                                error.message
                        );
                    });
            });

        // Formulaire modifier fournisseur
        document
            .getElementById("modifierFournisseurForm")
            .addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                const fournisseurId = data.id;

                // Validation
                if (!data.nom_fournisseur) {
                    alert("Veuillez remplir le nom du fournisseur");
                    return;
                }

                // Supprimer l'ID du data car il ne fait pas partie du sch√©ma de mise √† jour
                delete data.id;

                // Appel API pour modifier le fournisseur
                fetch(`/fournisseurs/${fournisseurId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                })
                    .then((response) => response.json())
                    .then((result) => {
                        if (result.id || result.nom_fournisseur) {
                            // Afficher un message de succ√®s
                            const alertDiv = document.createElement("div");
                            alertDiv.className =
                                "alert alert-success alert-dismissible fade show";
                            alertDiv.innerHTML = `
                                <i class="bi bi-check-circle"></i> Fournisseur modifi√© avec succ√®s
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;

                            // Ins√©rer l'alerte en haut de la page
                            const container =
                                document.querySelector(".container-fluid");
                            container.insertBefore(
                                alertDiv,
                                container.firstChild
                            );

                            bootstrap.Modal.getInstance(
                                document.getElementById(
                                    "modifierFournisseurModal"
                                )
                            ).hide();

                            // Recharger la page apr√®s un d√©lai
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            throw new Error(
                                result.detail ||
                                    result.message ||
                                    "Erreur inconnue"
                            );
                        }
                    })
                    .catch((error) => {
                        console.error("Erreur:", error);
                        alert(
                            "Erreur lors de la modification du fournisseur: " +
                                error.message
                        );
                    });
            });

        // Gestion de la confirmation de suppression
        document
            .getElementById("confirmerSuppression")
            .addEventListener("click", function () {
                if (fournisseurIdASupprimer) {
                    fetch(`/fournisseurs/${fournisseurIdASupprimer}`, {
                        method: "DELETE",
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.message) {
                                // Succ√®s
                                bootstrap.Modal.getInstance(
                                    document.getElementById(
                                        "confirmerSuppressionModal"
                                    )
                                ).hide();

                                // Afficher un message de succ√®s
                                const alertDiv = document.createElement("div");
                                alertDiv.className =
                                    "alert alert-success alert-dismissible fade show";
                                alertDiv.innerHTML = `
                            <i class="bi bi-check-circle"></i> Fournisseur supprim√© avec succ√®s
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;

                                // Ins√©rer l'alerte en haut de la page
                                const container =
                                    document.querySelector(".container-fluid");
                                container.insertBefore(
                                    alertDiv,
                                    container.firstChild
                                );

                                // Recharger la page apr√®s un d√©lai
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                throw new Error(
                                    data.detail ||
                                        "Erreur lors de la suppression"
                                );
                            }
                        })
                        .catch((error) => {
                            console.error("Erreur:", error);
                            alert(
                                "Erreur lors de la suppression: " +
                                    error.message
                            );
                        });
                }
            });
    });

    function modifierFournisseur(id) {
        // R√©cup√©rer les donn√©es du fournisseur via API
        fetch(`/fournisseurs/${id}`)
            .then((response) => response.json())
            .then((fournisseur) => {
                // Remplir le formulaire de modification avec tous les champs
                document.getElementById("modifId").value = fournisseur.id || "";
                document.getElementById("modifNomFournisseur").value =
                    fournisseur.nom_fournisseur || "";
                document.getElementById("modifAdresse").value =
                    fournisseur.adresse || "";
                document.getElementById("modifStatut").value =
                    fournisseur.statut || "Actif";

                // Contact 1
                document.getElementById("modifContact1Nom").value =
                    fournisseur.contact1_nom || "";
                document.getElementById("modifContact1Prenom").value =
                    fournisseur.contact1_prenom || "";
                document.getElementById("modifContact1Fonction").value =
                    fournisseur.contact1_fonction || "";
                document.getElementById("modifContact1TelFixe").value =
                    fournisseur.contact1_tel_fixe || "";
                document.getElementById("modifContact1TelMobile").value =
                    fournisseur.contact1_tel_mobile || "";
                document.getElementById("modifContact1Email").value =
                    fournisseur.contact1_email || "";

                // Contact 2
                document.getElementById("modifContact2Nom").value =
                    fournisseur.contact2_nom || "";
                document.getElementById("modifContact2Prenom").value =
                    fournisseur.contact2_prenom || "";
                document.getElementById("modifContact2Fonction").value =
                    fournisseur.contact2_fonction || "";
                document.getElementById("modifContact2TelFixe").value =
                    fournisseur.contact2_tel_fixe || "";
                document.getElementById("modifContact2TelMobile").value =
                    fournisseur.contact2_tel_mobile || "";
                document.getElementById("modifContact2Email").value =
                    fournisseur.contact2_email || "";

                // Afficher le modal
                new bootstrap.Modal(
                    document.getElementById("modifierFournisseurModal")
                ).show();
            })
            .catch((error) => {
                console.error("Erreur:", error);
                alert(
                    "Erreur lors de la r√©cup√©ration des donn√©es du fournisseur: " +
                        error.message
                );
            });
    }

    function supprimerFournisseur(id, nom) {
        fournisseurIdASupprimer = id;
        document.getElementById("fournisseur_nom_suppression").textContent =
            nom;

        // Ouvrir le modal de confirmation
        new bootstrap.Modal(
            document.getElementById("confirmerSuppressionModal")
        ).show();
    }

    function voirDetailsFournisseur(nomFournisseur) {
        // Rediriger vers la page de d√©tail du fournisseur
        window.location.href = `/fournisseur/${encodeURIComponent(
            nomFournisseur
        )}`;
    }
</script>

<style>
    .card-title {
        font-size: 1.5rem;
        font-weight: bold;
    }

    .badge {
        font-size: 0.8rem;
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    .table td {
        vertical-align: middle;
    }

    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}
