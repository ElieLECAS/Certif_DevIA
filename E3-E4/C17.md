## C17 — Développer les composants techniques et interfaces (Projet E3‑E4)

Ce document atteste la conformité du projet FastAPI « Chatbot SAV » avec les exigences de la compétence C17.

### 1) Environnement de développement conforme aux spécifications
- Outils et versions:
  - Python 3.11, FastAPI, SQLAlchemy, Alembic, Prometheus client, LangChain/FAISS, PyTest.
  - Conteneurisation via Docker et orchestration via Docker Compose (`web`, `db`, `prometheus`, `grafana`, `exporters`).
- Variables d’environnement chargeables via `.env` et `python-dotenv`; `DATABASE_URL`, `SECRET_KEY`, `OPENAI_API_KEY`, `OPENAI_MODEL`, etc.
- Migrations DB automatiques au démarrage du conteneur applicatif:
```30:31:E3-E4/fastapi/Dockerfile
CMD ["/bin/sh", "-c", "alembic upgrade head && uvicorn app:app --host 0.0.0.0 --port 8000"]
```
- Configuration CORS contrôlée par environnement (large en dev, restreinte en prod):
```82:90:E3-E4/fastapi/app.py
# Configuration CORS
ALLOWED_ORIGINS = os.getenv("ALLOWED_ORIGINS", "http://localhost:8000").split(",")
cors_allow_origins = ["*"] if DEBUG else ALLOWED_ORIGINS
app.add_middleware(
    CORSMiddleware,
    allow_origins=cors_allow_origins,
```

### 2) Interfaces intégrées et conformes aux maquettes
- Intégration Jinja2 + HTML5 sémantique avec rôles ARIA:
```31:38:E3-E4/fastapi/templates/base.html
<aside class="col-md-2" id="sidebar" role="complementary">
    <h3 class="text-white px-3 mb-4">Navigation</h3>
    <nav aria-label="Navigation principale">
```
- Design responsive (sidebar togglable, layout fluide), styles ciblés `static/css/styles.css`.
- Pages couvertes: `login`, `client_home`, `openai_chat`, `conversations_list`, `conversation_detail`, `dashboard`.

### 3) Comportements d’interface et navigation conformes aux spécifications
- Validation de formulaires côté client et ergonomie générale:
```82:92:E3-E4/fastapi/static/js/main.js
const forms = document.querySelectorAll(".needs-validation");
Array.from(forms).forEach((form) => {
  form.addEventListener("submit", (event) => {
    if (!form.checkValidity()) { event.preventDefault(); event.stopPropagation(); }
    form.classList.add("was-validated");
  });
});
```
- Navigation protégée (redirection vers login, 401/404 différenciés API vs pages) et UX de chat (indicateur de frappe, upload images).
- Accessibilité: repères ARIA (`role="banner"`, `role="complementary"`, `role="main"`), contraste renforcé et clavier.

### 4) Composants métier développés et conformes aux spécifications
- Modélisation SQLAlchemy (`User`, `ClientUser`, `Conversation`, `Commande`) et méthodes métier:
```62:78:E3-E4/fastapi/models.py
def add_message(self, role: str, content: str, image_path: str = None):
    if not self.history: self.history = []
    message = {"role": role, "content": content, "timestamp": datetime.utcnow().isoformat()}
    if image_path: message["image_path"] = image_path
    self.history.append(message)
    flag_modified(self, "history")
```
- Cycle de conversation et gestion d’historique avec génération IA (OpenAI) + contexte FAISS:
```511:515:E3-E4/fastapi/routes.py
from langchain_openai import ChatOpenAI
llm = ChatOpenAI(api_key=openai_api_key, model=os.getenv("OPENAI_MODEL"), max_tokens=500, temperature=0.4)
vectorstore = get_vectorstore(openai_api_key)
```
- Création/récupération d’une conversation conforme:
```43:69:E3-E4/fastapi/routes.py
def get_or_create_conversation(db: Session, user: User, conversation_id: Optional[str], client_name: str) -> Conversation:
    ...
    if not conversation:
        conversation = Conversation(client_name=client_name, status="nouveau", user_id=user.id)
        db.add(conversation); db.commit(); db.refresh(conversation)
```

### 5) Gestion des droits d’accès conforme aux spécifications
- Authentification JWT, stockage du token en cookie HTTPOnly, `secure` en prod:
```151:159:E3-E4/fastapi/routes.py
response.set_cookie(
    key="access_token",
    value=access_token,
    httponly=True,
    max_age=expire_minutes * 60,
    expires=expire_minutes * 60,
    secure=(not DEBUG),
    samesite=("lax" if not DEBUG else "lax")
)
```
- Rôles et contrôle d’accès (client vs staff/admin):
```102:104:E3-E4/fastapi/auth.py
def is_staff_or_admin(user: User):
    return user.is_staff or user.is_superuser
```
- Middleware/handlers pour 401/404 adaptés selon API/page (non redirection en JSON):
```225:246:E3-E4/fastapi/app.py
@app.exception_handler(HTTPException)
async def http_exception_handler(...):
    if exc.status_code == 401:
        is_api = request.url.path.startswith("/api")
        expects_json = "application/json" in accept_header
        if is_api or expects_json:
            return JSONResponse({"detail": exc.detail}, status_code=401, headers=headers)
        ...
```

### 6) Intégration des flux de données conforme aux spécifications
- Base PostgreSQL via `DATABASE_URL`, ORM SQLAlchemy, sessions `SessionLocal`.
- Fichiers clients et prompts chargés via utilitaires (préprompts rassemblés, FAISS pour la base documentaire).
- Upload images sécurisé (types vérifiés), persisté sur disque, historisé dans les messages.

### 7) Éco‑conception (exemples en place + préconisations)
- En place:
  - Limitation contextuelle IA: `max_tokens=500` pour contenir la latence et le coût.
  - Réutilisation d’index FAISS en singleton pour éviter les rechargements coûteux.
  - Monitoring pour observer la latence et éviter la surconsommation.
- Préconisations complémentaires (non bloquantes):
  - Minifier/concaténer assets statiques; lazy‑loading d’assets; politique de cache HTTP.
  - Seuils de taille pour uploads; purge/rétention d’uploads.
  - Budgets de perfs UX (LCP/CLS) et audit éco‑index périodique.

### 8) OWASP Top 10 — Mesures pertinentes implémentées
- A01 Broken Access Control: vérifications de rôles sur routes sensibles (admin only), 401/403 cohérents.
- A02 Cryptographic Failures: hachage Bcrypt via Passlib:
```23:32:E3-E4/fastapi/auth.py
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
def get_password_hash(password): return pwd_context.hash(password)
```
- A03 Injection: ORM SQLAlchemy; validation d’entrées avec Pydantic; headers/CORS stricts.
- A05 Security Misconfiguration: CORS conditionné par env; cookies HTTPOnly/SameSite; `SECRET_KEY` via env.
- A07 Identification and Authentication Failures: Auth JWT robuste; expiration configurable; 401 clairs.
- Journalisation d’erreurs, pas de secrets en clair; endpoints de monitoring séparés.

### 9) Tests unitaires et d’intégration
- Couverture des routes HTML, redirections, endpoints API, exigences d’auth/clé OpenAI:
```20:25:E3-E4/fastapi/tests/test_openai_api.py
monkeypatch.delenv("OPENAI_API_KEY", raising=False)
response = client.post("/api/chat", data={"message": "hello", "conversation_id": "temp"})
assert response.status_code == 401
```
```17:24:E3-E4/fastapi/tests/test_fastapi_endpoints.py
response = client.post("/login", data={"username": "tester", "password": "password"}, follow_redirects=False)
assert response.status_code == 302
assert response.headers["location"] == "/dashboard"