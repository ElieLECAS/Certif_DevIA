{% extends "base.html" %} 
{% block title %} Gestion des QR Codes - GMAO
{% endblock %} {% block content %}
<div class="container-xxl">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-qr-code me-2"></i>
                    Gestion des QR Codes
                </h1>
                <div class="d-flex gap-2">
                    {% if total_pages > 1 %}
                    <button
                        onclick="imprimerToutSansPagination()"
                        class="btn btn-success"
                    >
                        <i class="bi bi-printer-fill me-2"></i>
                        Imprimer tout (tous les produits filtrés)
                    </button>
                    {% endif %}
                    <button
                        onclick="imprimerSelection()"
                        class="btn btn-outline-primary"
                        id="btn-imprimer-selection"
                        disabled
                    >
                        <i class="bi bi-check2-square me-2"></i>
                        Imprimer sélection
                    </button>
                </div>
            </div>

            <!-- Onglets pour les sections -->
            <ul class="nav nav-tabs mb-4" id="qr-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link active"
                        id="produits-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#produits-section"
                        type="button"
                        role="tab"
                        aria-controls="produits-section"
                        aria-selected="true"
                    >
                        <i class="bi bi-box-seam me-2"></i>
                        QR Codes Produits ({{ total_produits }} total)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="tables-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#tables-section"
                        type="button"
                        role="tab"
                        aria-controls="tables-section"
                        aria-selected="false"
                    >
                        <i class="bi bi-table me-2"></i>
                        QR Codes Tables d'Atelier ({{ tables_atelier|length }})
                    </button>
                </li>
            </ul>

            <!-- Contenu des onglets -->
            <div class="tab-content" id="qr-tabs-content">
                <!-- Section Produits -->
                <div
                    class="tab-pane fade show active"
                    id="produits-section"
                    role="tabpanel"
                    aria-labelledby="produits-tab"
                >
                    <!-- Filtres Produits -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label
                                        for="filtre-fournisseur"
                                        class="form-label"
                                        >Fournisseur</label
                                    >
                                    <select
                                        class="form-select"
                                        id="filtre-fournisseur"
                                        onchange="filterByFournisseur()"
                                    >
                                        <option value="tous" {% if not fournisseur_filtre or fournisseur_filtre == 'tous' %}selected{% endif %}>
                                            Tous les fournisseurs
                                        </option>
                                        {% for fournisseur in fournisseurs %}
                                        <option
                                            value="{{ fournisseur.nom_fournisseur }}"
                                            {% if fournisseur_filtre == fournisseur.nom_fournisseur %}selected{% endif %}
                                        >
                                            {{ fournisseur.nom_fournisseur }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label
                                        for="filtre-categorie"
                                        class="form-label"
                                        >Catégorie</label
                                    >
                                    <select
                                        class="form-select"
                                        id="filtre-categorie"
                                        onchange="filtrerProduits()"
                                    >
                                        <option value="">
                                            Toutes les catégories
                                        </option>
                                        {% for categorie in categories %}
                                        <option value="{{ categorie }}">
                                            {{ categorie }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label
                                        for="filtre-recherche"
                                        class="form-label"
                                        >Recherche</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="filtre-recherche"
                                        placeholder="Rechercher par référence ou nom..."
                                        onkeyup="filtrerProduits()"
                                    />
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-8">
                                    <div class="form-check">
                                        <input
                                            class="form-check-input"
                                            type="checkbox"
                                            id="select-all-produits"
                                            onchange="toggleSelectAllProduits()"
                                        />
                                        <label
                                            class="form-check-label"
                                            for="select-all-produits"
                                        >
                                            Sélectionner tous les produits
                                            visibles
                                        </label>
                                    </div>
                                </div>
                                {% if total_pages > 1 %}
                                <div class="col-md-4 text-end">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Page {{ page }} sur {{ total_pages }}
                                        ({{ items_per_page }} produits par page)
                                        {% if fournisseur_filtre %}
                                        <br>
                                        <span class="badge bg-primary">
                                            <i class="bi bi-filter me-1"></i>
                                            Filtré par: {{ fournisseur_filtre }}
                                        </span>
                                        {% endif %}
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Grille des QR Codes Produits -->
                    <div
                        class="row d-print-none"
                        id="qr-codes-produits-container"
                    >
                        {% for produit in produits %}
                        <div
                            class="col-lg-4 col-md-6 col-12 mb-4 qr-code-item produit-item"
                            data-fournisseur="{{ produit.fournisseur or '' }}"
                            data-categorie="{{ produit.categorie or '' }}"
                            data-reference="{{ produit.reference }}"
                            data-nom="{{ produit.produits }}"
                        >
                            <div class="card qr-code-card">
                                <div
                                    class="card-header d-flex justify-content-between align-items-center"
                                >
                                    <div class="form-check">
                                        <input
                                            class="form-check-input qr-select produit-select"
                                            type="checkbox"
                                            id="select-produit-{{ produit.id }}"
                                            onchange="updateSelectionButtons()"
                                        />
                                        <label
                                            class="form-check-label fw-bold"
                                            for="select-produit-{{ produit.id }}"
                                        >
                                            {{ produit.reference }}
                                        </label>
                                    </div>
                                    <button
                                        class="btn btn-sm btn-outline-primary"
                                        onclick="imprimerQRCodeProduit('{{ produit.id }}')"
                                    >
                                        <i class="bi bi-printer"></i>
                                    </button>
                                </div>
                                <div class="card-body text-center">
                                    <!-- QR Code -->
                                    <div class="qr-code-container mb-3">
                                        {% if produit.qr_code %}
                                        <img
                                            src="{{ produit.qr_code }}"
                                            alt="QR Code {{ produit.reference }}"
                                            class="qr-code-image"
                                        />
                                        {% else %}
                                        <div
                                            style="
                                                width: 150px;
                                                height: 150px;
                                                background: #f0f0f0;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                color: #666;
                                                border: 1px solid #ddd;
                                                border-radius: 8px;
                                            "
                                        >
                                            QR Code manquant
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Informations produit -->
                                    <div class="product-info">
                                        <div class="row text-start">
                                            <div class="col-12 mb-2">
                                                <strong
                                                    >Référence Proferm:</strong
                                                ><br />
                                                <span class="text-primary"
                                                    >{{ produit.reference}}</span
                                                >
                                            </div>
                                            <div class="col-12 mb-2">
                                                <strong>Produit:</strong><br />
                                                <span
                                                    >{{ produit.produits}}</span
                                                >
                                            </div>
                                            <div class="col-12 mb-2">
                                                <strong>Fournisseur:</strong
                                                ><br />
                                                <span
                                                    >{{ produit.fournisseur or 'Non défini' }}</span
                                                >
                                            </div>
                                            <div class="col-12 mb-2">
                                                <strong
                                                    >Référence
                                                    Fournisseur:</strong
                                                ><br />
                                                <span
                                                    >{{ produit.reference_fournisseur or 'Non définie' }}</span
                                                >
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination des produits -->
                    {% if total_pages > 1 %}
                    <div
                        class="d-flex justify-content-between align-items-center mt-4 mb-3"
                    >
                        <div class="text-muted">
                            Affichage de {{ start_item }} à {{ end_item }} sur
                            {{ total_produits }} produits
                        </div>

                        <nav aria-label="Navigation des pages QR codes">
                            <ul class="pagination pagination-sm mb-0">
                                <!-- Première page -->
                                {% if page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if fournisseur_filtre %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                                        <i
                                            class="bi bi-chevron-double-left"
                                        ></i>
                                    </a>
                                </li>
                                {% endif %}

                                <!-- Page précédente -->
                                {% if page > 1 %}
                                <li class="page-item">
                                    <a
                                        class="page-link"
                                        href="?page={{ page - 1 }}{% if fournisseur_filtre %}&fournisseur={{ fournisseur_filtre }}{% endif %}"
                                    >
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                                {% endif %}

                                <!-- Pages numérotées -->
                                {% set start_page = [1, page - 2]|max %} {% set
                                end_page = [total_pages, page + 2]|min %} {% if
                                start_page > 1 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %} {% for p in range(start_page,
                                end_page + 1) %}
                                <li
                                    class="page-item {% if p == page %}active{% endif %}"
                                >
                                    <a class="page-link" href="?page={{ p }}{% if fournisseur_filtre %}&fournisseur={{ fournisseur_filtre }}{% endif %}"
                                        >{{ p }}</a
                                    >
                                </li>
                                {% endfor %} {% if end_page < total_pages %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}

                                <!-- Page suivante -->
                                {% if page < total_pages %}
                                <li class="page-item">
                                    <a
                                        class="page-link"
                                        href="?page={{ page + 1 }}{% if fournisseur_filtre %}&fournisseur={{ fournisseur_filtre }}{% endif %}"
                                    >
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                                {% endif %}

                                <!-- Dernière page -->
                                {% if page < total_pages %}
                                <li class="page-item">
                                    <a
                                        class="page-link"
                                        href="?page={{ total_pages }}{% if fournisseur_filtre %}&fournisseur={{ fournisseur_filtre }}{% endif %}"
                                    >
                                        <i
                                            class="bi bi-chevron-double-right"
                                        ></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>

                        <div class="text-muted">
                            {{ items_per_page }} produits par page
                        </div>
                    </div>
                    {% endif %}

                    <!-- Message si aucun produit -->
                    <div
                        id="no-products-message"
                        class="text-center py-5"
                        style="display: none"
                    >
                        <i class="bi bi-search display-1 text-muted"></i>
                        <p class="text-muted mt-3">
                            Aucun produit ne correspond aux critères de
                            recherche.
                        </p>
                    </div>
                </div>

                <!-- Section Tables d'Atelier -->
                <div
                    class="tab-pane fade"
                    id="tables-section"
                    role="tabpanel"
                    aria-labelledby="tables-tab"
                >
                    <!-- Filtres Tables -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label
                                        for="filtre-type-atelier"
                                        class="form-label"
                                        >Type d'Atelier</label
                                    >
                                    <select
                                        class="form-select"
                                        id="filtre-type-atelier"
                                        onchange="filtrerTables()"
                                    >
                                        <option value="">Tous les types</option>
                                        {% for type_atelier in types_atelier %}
                                        <option value="{{ type_atelier }}">
                                            {{ type_atelier }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label
                                        for="filtre-statut-table"
                                        class="form-label"
                                        >Statut</label
                                    >
                                    <select
                                        class="form-select"
                                        id="filtre-statut-table"
                                        onchange="filtrerTables()"
                                    >
                                        <option value="">
                                            Tous les statuts
                                        </option>
                                        <option value="Actif">Actif</option>
                                        <option value="Inactif">Inactif</option>
                                        <option value="Maintenance">
                                            Maintenance
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label
                                        for="filtre-recherche-table"
                                        class="form-label"
                                        >Recherche</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="filtre-recherche-table"
                                        placeholder="Rechercher par ID ou nom..."
                                        onkeyup="filtrerTables()"
                                    />
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="form-check">
                                        <input
                                            class="form-check-input"
                                            type="checkbox"
                                            id="select-all-tables"
                                            onchange="toggleSelectAllTables()"
                                        />
                                        <label
                                            class="form-check-label"
                                            for="select-all-tables"
                                        >
                                            Sélectionner toutes les tables
                                            visibles
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grille des QR Codes Tables -->
                    <div
                        class="row d-print-none"
                        id="qr-codes-tables-container"
                    >
                        {% for table in tables_atelier %}
                        <div
                            class="col-lg-4 col-md-6 col-12 mb-4 qr-code-item table-item"
                            data-type-atelier="{{ table.type_atelier or '' }}"
                            data-statut="{{ table.statut or '' }}"
                            data-id-table="{{ table.id_table }}"
                            data-nom-table="{{ table.nom_table }}"
                        >
                            <div class="card qr-code-card">
                                <div
                                    class="card-header d-flex justify-content-between align-items-center"
                                >
                                    <div class="form-check">
                                        <input
                                            class="form-check-input qr-select table-select"
                                            type="checkbox"
                                            id="select-table-{{ table.id }}"
                                            onchange="updateSelectionButtons()"
                                        />
                                        <label
                                            class="form-check-label fw-bold"
                                            for="select-table-{{ table.id }}"
                                        >
                                            {{ table.id_table }}
                                        </label>
                                    </div>
                                    <button
                                        class="btn btn-sm btn-outline-primary"
                                        onclick="imprimerQRCodeTable('{{ table.id }}')"
                                    >
                                        <i class="bi bi-printer"></i>
                                    </button>
                                </div>
                                <div class="card-body text-center">
                                    <!-- QR Code -->
                                    <div class="qr-code-container mb-3">
                                        {% if table.qr_code %}
                                        <img
                                            src="{{ table.qr_code }}"
                                            alt="QR Code {{ table.id_table }}"
                                            class="qr-code-image"
                                        />
                                        {% else %}
                                        <div
                                            style="
                                                width: 150px;
                                                height: 150px;
                                                background: #f0f0f0;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                color: #666;
                                                border: 1px solid #ddd;
                                                border-radius: 8px;
                                            "
                                        >
                                            QR Code manquant
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Informations table -->
                                    <div class="table-info">
                                        <div class="row text-start">
                                            <div class="col-12 mb-2">
                                                <strong>ID Table:</strong><br />
                                                <span class="text-primary"
                                                    >{{ table.id_table }}</span
                                                >
                                            </div>
                                            <div class="col-12 mb-2">
                                                <strong>Nom:</strong><br />
                                                <span
                                                    >{{ table.nom_table }}</span
                                                >
                                            </div>
                                            <div class="col-12 mb-2">
                                                <strong>Type d'Atelier:</strong
                                                ><br />
                                                <span
                                                    >{{ table.type_atelier or 'Non défini' }}</span
                                                >
                                            </div>
                                            <div class="col-12 mb-2">
                                                <strong>Statut:</strong><br />
                                                <span
                                                    class="badge bg-{% if table.statut == 'Actif' %}success{% elif table.statut == 'Maintenance' %}warning{% else %}secondary{% endif %}"
                                                >
                                                    {{ table.statut or 'Non défini' }}
                                                </span>
                                            </div>
                                            {% if table.emplacement %}
                                            <div class="col-12 mb-2">
                                                <strong>Emplacement:</strong
                                                ><br />
                                                <span
                                                    >{{ table.emplacement }}</span
                                                >
                                            </div>
                                            {% endif %} 
                                            {% if table.responsable %}
                                            <div class="col-12 mb-2">
                                                <strong>Responsable:</strong
                                                ><br />
                                                <span
                                                    >{{ table.responsable }}</span
                                                >
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Message si aucune table -->
                    <div
                        id="no-tables-message"
                        class="text-center py-5"
                        style="display: none"
                    >
                        <i class="bi bi-search display-1 text-muted"></i>
                        <p class="text-muted mt-3">
                            Aucune table ne correspond aux critères de
                            recherche.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Étiquettes pour l'impression - Produits -->
            <div class="labels-container d-none d-print-block">
                {% for produit in produits %}
                <div
                    class="label-item produit-label"
                    data-produit-id="{{ produit.id }}"
                    data-fournisseur="{{ produit.fournisseur or '' }}"
                    data-categorie="{{ produit.categorie or '' }}"
                    data-reference="{{ produit.reference }}"
                    data-nom="{{ produit.produits }}"
                >
                    <div class="label">
                        <div class="label-qr">
                            {% if produit.qr_code %}
                            <img
                                src="{{ produit.qr_code }}"
                                alt="QR {{ produit.reference }}"
                                style="
                                    display: block !important;
                                    width: 26mm !important;
                                    height: 26mm !important;
                                    visibility: visible !important;
                                "
                            />
                            {% else %}
                            <div
                                style="
                                    width: 26mm;
                                    height: 26mm;
                                    background: #f0f0f0;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 8pt;
                                    color: #666;
                                "
                            >
                                QR manquant
                            </div>
                            {% endif %}
                        </div>
                        <div class="label-info">
                            <div class="label-reference">
                                {{ produit.reference }}
                            </div>
                            <div class="label-product">
                                {{ produit.produits[:40] }}
                                {% if produit.produits|length > 40 %}...
                                {% endif %}
                            </div>
                            <div class="label-supplier">
                                {{ produit.fournisseur or 'Non renseigné' }}
                            </div>
                            <div class="label-ref-supplier">
                                {{ produit.reference_fournisseur or 'Non renseigné' }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Étiquettes pour l'impression - Tables -->
                {% for table in tables_atelier %}
                <div
                    class="label-item table-label"
                    data-table-id="{{ table.id }}"
                    data-type-atelier="{{ table.type_atelier or '' }}"
                    data-statut="{{ table.statut or '' }}"
                    data-id-table="{{ table.id_table }}"
                    data-nom-table="{{ table.nom_table }}"
                >
                    <div class="label">
                        <div class="label-qr">
                            {% if table.qr_code %}
                            <img
                                src="{{ table.qr_code }}"
                                alt="QR {{ table.id_table }}"
                                style="
                                    display: block !important;
                                    width: 26mm !important;
                                    height: 26mm !important;
                                    visibility: visible !important;
                                "
                            />
                            {% else %}
                            <div
                                style="
                                    width: 26mm;
                                    height: 26mm;
                                    background: #f0f0f0;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 8pt;
                                    color: #666;
                                "
                            >
                                QR manquant
                            </div>
                            {% endif %}
                        </div>
                        <div class="label-info">
                            <div class="label-reference">
                                {{ table.id_table }}
                            </div>
                            <div class="label-product">
                                {{ table.nom_table[:40] }}
                                {% if table.nom_table|length > 40 %}...{% endif %}
                            </div>
                            <div class="label-supplier">
                                {{ table.type_atelier or 'Non renseigné' }}
                            </div>
                            <div class="label-ref-supplier">
                                {{ table.statut or 'Non renseigné' }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Styles pour l'affichage écran */
    .qr-code-image {
        width: 150px;
        height: 150px;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    .qr-code-container {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .product-info {
        font-size: 0.9rem;
    }

    .qr-code-card {
        transition: all 0.3s ease;
    }

    .qr-code-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .selected-for-print .qr-code-card {
        border: 2px solid var(--primary-color) !important;
        background-color: var(--primary-light) !important;
    }

    /* Styles pour les onglets */
    .nav-tabs .nav-link {
        color: #6c757d;
        border: 1px solid transparent;
        border-bottom-color: #dee2e6;
    }

    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6;
        color: #495057;
    }

    .nav-tabs .nav-link.active {
        color: #495057;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
    }

    /* Styles spécifiques pour les tables */
    .table-info {
        font-size: 0.9rem;
    }

    .table-item .qr-code-card {
        border-left: 4px solid #17a2b8;
    }

    .produit-item .qr-code-card {
        border-left: 4px solid #28a745;
    }

    /* Styles pour les étiquettes d'impression */
    .labels-container {
        display: flex;
        flex-wrap: wrap;
        margin: 0;
        padding: 0;
    }

    .label {
        width: 90mm;
        height: 36mm;
        border: 1px solid #000;
        margin: 3mm;
        padding: 3mm;
        display: flex;
        align-items: center;
        box-sizing: border-box;
        page-break-inside: avoid;
        font-family: Arial, sans-serif;
        background: white;
    }

    .label-qr {
        width: 28mm;
        height: 28mm;
        margin-right: 6mm;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        padding: 1mm;
    }

    .label-qr img {
        width: 26mm;
        height: 26mm;
        object-fit: contain;
        display: block !important;
        visibility: visible !important;
    }

    .label-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 28mm;
        overflow: hidden;
        padding-left: 2mm;
    }

    .label-reference {
        font-weight: bold;
        font-size: 12pt;
        color: #000;
        margin-bottom: 1mm;
        line-height: 1.1;
    }

    .label-product {
        font-size: 9pt;
        color: #333;
        margin-bottom: 1mm;
        line-height: 1.1;
        word-wrap: break-word;
        overflow: hidden;
    }

    .label-supplier {
        font-size: 8pt;
        color: #666;
        margin-bottom: 1mm;
        line-height: 1.1;
    }

    .label-ref-supplier {
        font-size: 8pt;
        color: #666;
        font-style: italic;
        line-height: 1.1;
    }

    @media print {
        /* Masquer tous les éléments sauf les étiquettes */
        body * {
            visibility: hidden;
        }

        .labels-container,
        .labels-container * {
            visibility: visible;
        }

        .labels-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        /* Configuration de la page */
        @page {
            size: A4;
            margin: 8mm;
        }

        body {
            margin: 0;
            padding: 0;
            background: white;
        }

        /* Par défaut, masquer toutes les étiquettes */
        .label-item {
            display: none !important;
        }

        /* Afficher toutes les étiquettes lors de l'impression complète */
        body.print-all .label-item {
            display: block !important;
        }

        /* Afficher seulement les étiquettes sélectionnées lors de l'impression sélective */
        body.print-selection .label-item.selected-for-print {
            display: block !important;
        }

        /* Optimisation pour planche d'étiquettes */
        .labels-container {
            display: flex !important;
            flex-wrap: wrap !important;
            align-content: flex-start !important;
        }

        .label {
            margin: 2mm !important;
            border: 1px solid #000 !important;
        }
    }
</style>

<script>
    // Fonction pour filtrer par fournisseur (côté serveur)
    function filterByFournisseur() {
        const fournisseur = document.getElementById("filtre-fournisseur").value;
        const url = new URL(window.location);
        
        if (fournisseur === 'tous') {
            url.searchParams.delete('fournisseur');
        } else {
            url.searchParams.set('fournisseur', fournisseur);
        }
        
        // Réinitialiser la page à 1 lors du changement de filtre
        url.searchParams.set('page', '1');
        
        window.location.href = url.toString();
    }

    // Fonctions pour les produits (filtres côté client pour catégorie et recherche)
    function filtrerProduits() {
        const filtreCategorie = document
            .getElementById("filtre-categorie")
            .value.toLowerCase();
        const filtreRecherche = document
            .getElementById("filtre-recherche")
            .value.toLowerCase();

        const items = document.querySelectorAll(".produit-item");
        let visibleCount = 0;

        items.forEach((item) => {
            const categorie = item.dataset.categorie.toLowerCase();
            const reference = item.dataset.reference.toLowerCase();
            const nom = item.dataset.nom.toLowerCase();

            const matchCategorie =
                !filtreCategorie || categorie.includes(filtreCategorie);
            const matchRecherche =
                !filtreRecherche ||
                reference.includes(filtreRecherche) ||
                nom.includes(filtreRecherche);

            if (matchCategorie && matchRecherche) {
                item.style.display = "block";
                const labelItem = document.querySelector(
                    `.produit-label[data-reference="${item.dataset.reference}"]`
                );
                if (labelItem) {
                    labelItem.style.display = "block";
                }
                visibleCount++;
            } else {
                item.style.display = "none";
                const labelItem = document.querySelector(
                    `.produit-label[data-reference="${item.dataset.reference}"]`
                );
                if (labelItem) {
                    labelItem.style.display = "none";
                }
                const checkbox = item.querySelector(".produit-select");
                if (checkbox) checkbox.checked = false;
            }
        });

        const noProductsMessage = document.getElementById(
            "no-products-message"
        );
        if (visibleCount === 0) {
            noProductsMessage.style.display = "block";
        } else {
            noProductsMessage.style.display = "none";
        }

        updateSelectionButtons();
    }

    function toggleSelectAllProduits() {
        const selectAll = document.getElementById("select-all-produits");
        const visibleCheckboxes = document.querySelectorAll(
            '.produit-item:not([style*="display: none"]) .produit-select'
        );

        visibleCheckboxes.forEach((checkbox) => {
            checkbox.checked = selectAll.checked;
        });

        updateSelectionButtons();
    }

    // Fonctions pour les tables
    function filtrerTables() {
        const filtreTypeAtelier = document.getElementById(
            "filtre-type-atelier"
        ).value;
        const filtreStatut = document.getElementById(
            "filtre-statut-table"
        ).value;
        const filtreRecherche = document
            .getElementById("filtre-recherche-table")
            .value.toLowerCase();

        const items = document.querySelectorAll(".table-item");
        let visibleCount = 0;

        items.forEach((item) => {
            const typeAtelier = item.dataset.typeAtelier;
            const statut = item.dataset.statut;
            const idTable = item.dataset.idTable.toLowerCase();
            const nomTable = item.dataset.nomTable.toLowerCase();

            const matchTypeAtelier =
                !filtreTypeAtelier || typeAtelier === filtreTypeAtelier;
            const matchStatut = !filtreStatut || statut === filtreStatut;
            const matchRecherche =
                !filtreRecherche ||
                idTable.includes(filtreRecherche) ||
                nomTable.includes(filtreRecherche);

            if (matchTypeAtelier && matchStatut && matchRecherche) {
                item.style.display = "block";
                const labelItem = document.querySelector(
                    `.table-label[data-id-table="${item.dataset.idTable}"]`
                );
                if (labelItem) {
                    labelItem.style.display = "block";
                }
                visibleCount++;
            } else {
                item.style.display = "none";
                const labelItem = document.querySelector(
                    `.table-label[data-id-table="${item.dataset.idTable}"]`
                );
                if (labelItem) {
                    labelItem.style.display = "none";
                }
                const checkbox = item.querySelector(".table-select");
                if (checkbox) checkbox.checked = false;
            }
        });

        const noTablesMessage = document.getElementById("no-tables-message");
        if (visibleCount === 0) {
            noTablesMessage.style.display = "block";
        } else {
            noTablesMessage.style.display = "none";
        }

        updateSelectionButtons();
    }

    function toggleSelectAllTables() {
        const selectAll = document.getElementById("select-all-tables");
        const visibleCheckboxes = document.querySelectorAll(
            '.table-item:not([style*="display: none"]) .table-select'
        );

        visibleCheckboxes.forEach((checkbox) => {
            checkbox.checked = selectAll.checked;
        });

        updateSelectionButtons();
    }

    // Fonctions communes
    function updateSelectionButtons() {
        const selectedCheckboxes =
            document.querySelectorAll(".qr-select:checked");
        const btnImprimerSelection = document.getElementById(
            "btn-imprimer-selection"
        );

        if (selectedCheckboxes.length > 0) {
            btnImprimerSelection.disabled = false;
            btnImprimerSelection.innerHTML = `<i class="bi bi-check2-square me-2"></i>Imprimer sélection (${selectedCheckboxes.length})`;
        } else {
            btnImprimerSelection.disabled = true;
            btnImprimerSelection.innerHTML =
                '<i class="bi bi-check2-square me-2"></i>Imprimer sélection';
        }
    }

    function imprimerSelection() {
        const selectedCheckboxes =
            document.querySelectorAll(".qr-select:checked");

        if (selectedCheckboxes.length === 0) {
            alert("Veuillez sélectionner au moins un élément à imprimer.");
            return;
        }

        // Nettoyer d'abord toutes les sélections
        document.querySelectorAll(".label-item").forEach((item) => {
            item.classList.remove("selected-for-print");
        });

        // Marquer les étiquettes correspondantes aux éléments sélectionnés
        selectedCheckboxes.forEach((checkbox) => {
            if (checkbox.classList.contains("produit-select")) {
                const produitId = checkbox.id.replace("select-produit-", "");
                const labelItem = document.querySelector(
                    `.produit-label[data-produit-id="${produitId}"]`
                );
                if (labelItem) {
                    labelItem.classList.add("selected-for-print");
                }
            } else if (checkbox.classList.contains("table-select")) {
                const tableId = checkbox.id.replace("select-table-", "");
                const labelItem = document.querySelector(
                    `.table-label[data-table-id="${tableId}"]`
                );
                if (labelItem) {
                    labelItem.classList.add("selected-for-print");
                }
            }
        });

        // Configurer le body pour l'impression sélective
        document.body.classList.remove("print-all");
        document.body.classList.add("print-selection");

        // Lancer l'impression
        window.print();

        // Nettoyer après l'impression
        setTimeout(() => {
            document.body.classList.remove("print-selection");
            document.querySelectorAll(".label-item").forEach((item) => {
                item.classList.remove("selected-for-print");
            });
        }, 1000);
    }

    function imprimerQRCodeProduit(produitId) {
        // Nettoyer d'abord toutes les sélections
        document.querySelectorAll(".label-item").forEach((item) => {
            item.classList.remove("selected-for-print");
        });

        // Marquer seulement l'étiquette de ce produit pour l'impression
        const labelItem = document.querySelector(
            `.produit-label[data-produit-id="${produitId}"]`
        );
        if (labelItem) {
            labelItem.classList.add("selected-for-print");
        }

        // Configurer le body pour l'impression sélective
        document.body.classList.remove("print-all");
        document.body.classList.add("print-selection");

        // Lancer l'impression
        window.print();

        // Nettoyer après l'impression
        setTimeout(() => {
            document.body.classList.remove("print-selection");
            document.querySelectorAll(".label-item").forEach((item) => {
                item.classList.remove("selected-for-print");
            });
        }, 1000);
    }

    function imprimerQRCodeTable(tableId) {
        // Nettoyer d'abord toutes les sélections
        document.querySelectorAll(".label-item").forEach((item) => {
            item.classList.remove("selected-for-print");
        });

        // Marquer seulement l'étiquette de cette table pour l'impression
        const labelItem = document.querySelector(
            `.table-label[data-table-id="${tableId}"]`
        );
        if (labelItem) {
            labelItem.classList.add("selected-for-print");
        }

        // Configurer le body pour l'impression sélective
        document.body.classList.remove("print-all");
        document.body.classList.add("print-selection");

        // Lancer l'impression
        window.print();

        // Nettoyer après l'impression
        setTimeout(() => {
            document.body.classList.remove("print-selection");
            document.querySelectorAll(".label-item").forEach((item) => {
                item.classList.remove("selected-for-print");
            });
        }, 1000);
    }

    function imprimerToutSectionActive() {
        // Nettoyer d'abord toutes les sélections
        document.querySelectorAll('.label-item').forEach((item) => {
            item.classList.remove('selected-for-print');
        });

        // Sélectionner tous les produits visibles
        document.querySelectorAll('.produit-item').forEach((item) => {
            const produitId = item.querySelector('.produit-select')?.id.replace('select-produit-', '');
            const labelItem = document.querySelector(`.produit-label[data-produit-id="${produitId}"]`);
            if (labelItem) {
                labelItem.classList.add('selected-for-print');
            }
        });
        // Sélectionner toutes les tables visibles
        document.querySelectorAll('.table-item').forEach((item) => {
            const tableId = item.querySelector('.table-select')?.id.replace('select-table-', '');
            const labelItem = document.querySelector(`.table-label[data-table-id="${tableId}"]`);
            if (labelItem) {
                labelItem.classList.add('selected-for-print');
            }
        });
        // Configurer le body pour l'impression sélective
        document.body.classList.remove('print-all');
        document.body.classList.add('print-selection');
        // Lancer l'impression
        window.print();
        // Nettoyer après l'impression
        setTimeout(() => {
            document.body.classList.remove('print-selection');
            document.querySelectorAll('.label-item').forEach((item) => {
                item.classList.remove('selected-for-print');
            });
        }, 1000);
    }

    function imprimerToutSansPagination() {
        // Construire l'URL avec tous les filtres actuels + all=1
        const url = new URL(window.location.href);
        url.searchParams.set('all', '1');
        // On garde les filtres fournisseur, catégorie, recherche, etc.
        window.location.href = url.toString();
    }

    // Après le DOMContentLoaded, si all=1 dans l'URL, lancer l'impression automatiquement
    if (window.location.search.includes('all=1')) {
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                imprimerToutSectionActive();
            }, 500);
        });
    }
</script>
{% endblock %}
