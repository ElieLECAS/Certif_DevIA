{% extends "base.html" %} {% block title %}Alertes de Stock - GMAO Mobile{%
endblock %} {% block extra_css %}
<style>
    .alert-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
        border-radius: 10px;
    }

    .alert-card.critique {
        border-left: 5px solid #dc3545;
    }

    .alert-card.faible {
        border-left: 5px solid #ffc107;
    }

    .alert-card.surstock {
        border-left: 5px solid #fd7e14;
    }

    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: none;
        height: 100%;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0;
    }

    .alert-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 20px;
        font-weight: bold;
    }

    .badge-critique {
        background-color: #dc3545;
        color: white;
    }

    .badge-faible {
        background-color: #ffc107;
        color: black;
    }

    .badge-surstock {
        background-color: #fd7e14;
        color: white;
    }

    .recommendation {
        background: #e3f2fd;
        border-radius: 8px;
        padding: 0.5rem;
        margin-top: 0.5rem;
    }

    .no-alerts {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        margin: 2rem 0;
    }

    .export-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 2rem;
    }

    /* Styles pour les tuiles de produits */
    .product-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        height: 100%;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .product-category {
        font-size: 0.8rem;
        color: #17a2b8;
        font-weight: 500;
    }

    .alert-priority {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .alert-priority.critique {
        background-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
    }

    .alert-priority.faible {
        background-color: #ffc107;
        box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2);
    }

    .alert-priority.surstock {
        background-color: #fd7e14;
        box-shadow: 0 0 0 3px rgba(253, 126, 20, 0.2);
    }

    .stock-status {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .stock-status.critique {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
    }

    .stock-status.faible {
        color: #ffc107;
        background-color: rgba(255, 193, 7, 0.1);
    }

    .stock-status.surstock {
        color: #fd7e14;
        background-color: rgba(253, 126, 20, 0.1);
    }

    .recommendation {
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 8px;
        margin-top: 1rem;
        font-size: 0.85rem;
        color: #495057;
    }

    .recommendation i {
        color: #007bff;
        margin-right: 0.5rem;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .action-buttons .btn {
        flex: 1;
        min-width: 100px;
    }

    /* Filtres */
    .filter-btn {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .filter-btn.active {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }

    .filter-btn:not(.active):hover {
        transform: translateY(-2px);
    }

    /* Styles pour la vue tableau */
    .alert-priority-badge {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .alert-priority-badge.critique {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
    }

    .alert-priority-badge.faible {
        color: #ffc107;
        background-color: rgba(255, 193, 7, 0.1);
    }

    .alert-priority-badge.surstock {
        color: #fd7e14;
        background-color: rgba(253, 126, 20, 0.1);
    }

    #alertsTable th {
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }

    #alertsTable td {
        vertical-align: middle;
    }

    #alertsTable tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .product-card {
            margin-bottom: 1rem;
        }
        
        .action-buttons .btn {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
        }

        /* Masquer certaines colonnes sur mobile */
        #alertsTable th:nth-child(4),
        #alertsTable td:nth-child(4),
        #alertsTable th:nth-child(5),
        #alertsTable td:nth-child(5),
        #alertsTable th:nth-child(7),
        #alertsTable td:nth-child(7) {
            display: none;
        }
    }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
    <!-- En-t√™te -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="bi bi-exclamation-triangle"></i> Alertes de Stock</h4>
        <div class="d-flex align-items-center gap-3">
            <!-- Switch vue tuiles/tableau -->
            <div class="d-flex align-items-center">
                <span class="me-2 text-muted">
                    <i class="bi bi-grid-3x3-gap"></i>
                </span>
                <div class="form-check form-switch">
                    <input
                        class="form-check-input"
                        type="checkbox"
                        id="viewToggle"
                        onchange="toggleView()"
                    />
                    <label class="form-check-label" for="viewToggle"></label>
                </div>
                <span class="ms-2 text-muted">
                    <i class="bi bi-table"></i>
                </span>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>

    <!-- Filtre par fournisseur -->
    <div class="mb-3">
        <div class="row g-2">
            <div class="col-12 col-md-6">
                <label class="form-label fw-bold">
                    <i class="bi bi-building"></i> Filtrer par fournisseur
                </label>
                <select class="form-select" id="fournisseurFilter" onchange="filterByFournisseur()">
                    <option value="tous" {% if not fournisseur_filtre or fournisseur_filtre == 'tous' %}selected{% endif %}>
                        Tous les fournisseurs
                    </option>
                    {% for fournisseur in fournisseurs %}
                    <option value="{{ fournisseur.nom_fournisseur }}" {% if fournisseur_filtre == fournisseur.nom_fournisseur %}selected{% endif %}>
                        {{ fournisseur.nom_fournisseur }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="row g-2 mb-3">
        <div class="col-12 col-md-6">
            <button class="btn btn-success w-100" onclick="openBonCommandeModal()">
                <i class="bi bi-cart-plus"></i> G√©n√©rer Bon de commande
            </button>
        </div>
        <div class="col-12 col-md-6">
            <button class="btn btn-outline-primary w-100" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i> Actualiser
            </button>
        </div>
    </div>

    <!-- Statistiques des alertes -->
    <div class="row g-3 mb-4">
        <div class="col-4">
            <div class="stats-card">
                <div class="stat-number text-danger" id="count-critique">
                    {{ total_critique }}
                </div>
                <p class="stat-label">üî¥ Stock critique</p>
            </div>
        </div>
        <div class="col-4">
            <div class="stats-card">
                <div class="stat-number text-warning" id="count-faible">
                    {{ total_faible }}
                </div>
                <p class="stat-label">üü† Bient√¥t en rupture</p>
            </div>
        </div>
        <div class="col-4">
            <div class="stats-card">
                <div
                    class="stat-number"
                    style="color: #fd7e14"
                    id="count-surstock"
                >
                    {{ total_surstock }}
                </div>
                <p class="stat-label">üü° Surstock</p>
            </div>
        </div>
    </div>

    <!-- Informations de pagination -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="text-muted">
            <i class="bi bi-info-circle"></i>
            Affichage de {{ start_index }} √† {{ end_index }} sur {{ total_products }} alertes
            {% if fournisseur_filtre and fournisseur_filtre != 'tous' %}
            <span class="badge bg-primary ms-2">
                <i class="bi bi-filter"></i> {{ fournisseur_filtre }}
            </span>
            {% endif %}
        </div>
        {% if total_pages > 1 %}
        <div class="d-flex align-items-center">
            <span class="text-muted me-2">Page {{ current_page }} sur {{ total_pages }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Pagination (haut) -->
    {% if total_pages > 1 %}
    <nav aria-label="Navigation des alertes" class="mb-3">
        <ul class="pagination pagination-sm justify-content-center">
            <!-- Premi√®re page -->
            {% if current_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
            </li>
            {% endif %}
            
            <!-- Page pr√©c√©dente -->
            {% if current_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ current_page - 1 }}{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            <!-- Pages num√©rot√©es -->
            {% set start_page = [current_page - 2, 1]|max %}
            {% set end_page = [current_page + 2, total_pages]|min %}
            
            {% for page_num in range(start_page, end_page + 1) %}
            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                <a class="page-link" href="?page={{ page_num }}{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    {{ page_num }}
                </a>
            </li>
            {% endfor %}

            <!-- Page suivante -->
            {% if current_page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ current_page + 1 }}{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
            
            <!-- Derni√®re page -->
            {% if current_page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ total_pages }}{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}



    <!-- Vue tuiles -->
    <div id="tilesView">
        <!-- Grille des produits en alerte -->
        <div class="row g-3" id="products-grid">
        {% if produits %}
        {% for produit in produits %}
        <div class="col-12 col-md-6 col-lg-4 product-tile" data-product-id="{{ produit.id }}" data-status="{{ produit.statut }}">
            <div class="card h-100 product-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            {% if produit.image_url %}
                            <img
                                src="{{ produit.image_url }}"
                                class="me-2 rounded"
                                width="50"
                                height="50"
                                alt="{{ produit.designation }}"
                            />
                            {% else %}
                            <div
                                class="me-2 rounded bg-light d-flex align-items-center justify-content-center"
                                style="width: 50px; height: 50px"
                            >
                                <i
                                    class="bi bi-box text-secondary"
                                    style="font-size: 1.5rem"
                                ></i>
                            </div>
                            {% endif %}
                            <div>
                                <h6 class="card-title mb-1">
                                    {{ produit.designation or produit.produits }}
                                </h6>
                                <span class="product-category">{{ produit.categorie or 'Non cat√©goris√©' }}</span>
                            </div>
                        </div>
                        <!-- Indicateur de priorit√© -->
                        <div class="alert-priority {{ produit.statut }}"></div>
                    </div>
                    
                    <div class="product-details">
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-upc"></i> R√©f√©rence: <span class="product-reference">{{ produit.reference }}</span>
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-tag"></i> R√©f. Fournisseur: <span class="product-ref-fournisseur">{{ produit.reference_fournisseur or '-' }}</span>
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-building"></i> Fournisseur: {{ produit.fournisseur or '-' }}
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-geo-alt"></i> Emplacement: {{ produit.emplacement or '-' }}
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-box-seam"></i> Stock actuel: <strong>{{ produit.quantite }}</strong>
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-arrow-down-circle"></i> Stock minimum: <strong>{{ produit.stock_min or 0 }}</strong>
                            </small>
                        </div>
                        {% if produit.stock_max %}
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-arrow-up-circle"></i> Stock maximum: <strong>{{ produit.stock_max }}</strong>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="stock-info">
                            <span class="stock-status {{ produit.statut }}">
                                {% if produit.statut == 'critique' %}
                                <i class="bi bi-exclamation-triangle-fill"></i> Stock critique
                                {% elif produit.statut == 'faible' %}
                                <i class="bi bi-exclamation-circle-fill"></i> Stock faible
                                {% elif produit.statut == 'surstock' %}
                                <i class="bi bi-archive-fill"></i> Surstock
                                {% endif %}
                            </span>
                        </div>
                        <div class="stock-quantity">
                            <span class="badge bg-light text-dark">
                                <i class="bi bi-box-seam"></i> {{ produit.quantite }}
                            </span>
                        </div>
                    </div>

                    <!-- Recommandation -->
                    <div class="recommendation">
                        <i class="bi bi-lightbulb"></i>
                        {% if produit.statut == 'critique' %}
                        <strong>Action urgente :</strong> R√©approvisionner imm√©diatement ce produit !<br>
                        {% if produit.stock_max %}
                        <small><i class="bi bi-cart-plus"></i> <strong>Quantit√© recommand√©e :</strong> {{ produit.stock_max - produit.quantite }} unit√©s pour atteindre le stock max</small>
                        {% endif %}
                        {% elif produit.statut == 'faible' %}
                        <strong>Attention :</strong> Pr√©voir un r√©approvisionnement rapidement.<br>
                        {% if produit.stock_max %}
                        <small><i class="bi bi-cart-plus"></i> <strong>Quantit√© recommand√©e :</strong> {{ produit.stock_max - produit.quantite }} unit√©s pour atteindre le stock max</small>
                        {% endif %}
                        {% elif produit.statut == 'surstock' %}
                        <strong>Optimisation :</strong> Stock √©lev√©, √©viter les nouvelles commandes.<br>
                        {% if produit.stock_max %}
                        <small><i class="bi bi-info-circle"></i> <strong>Exc√©dent :</strong> {{ produit.quantite - produit.stock_max }} unit√©s au-dessus du stock max</small>
                        {% endif %}
                        {% endif %}
                    </div>

                    <!-- Boutons d'action -->
                    <div class="action-buttons">
                        <a href="/produit/{{ produit.reference }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye"></i> D√©tails
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i>
                <strong>Aucune alerte de stock d√©tect√©e</strong><br>
                Tous vos produits sont dans les seuils de stock normaux.
            </div>
        </div>
        {% endif %}
        </div>
    </div>

    <!-- Vue tableau -->
    <div id="tableView" class="d-none">
        <div class="table-responsive">
            <table class="table table-hover" id="alertsTable">
                <thead class="table-light">
                    <tr>
                        <th>Priorit√©</th>
                        <th>Produit</th>
                        <th>R√©f√©rence</th>
                        <th>Fournisseur</th>
                        <th>Emplacement</th>
                        <th>Stock</th>
                        <th>Seuils</th>
                        <th>Recommandation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if produits %}
                    {% for produit in produits %}
                    <tr data-status="{{ produit.statut }}" data-product-id="{{ produit.id }}">
                        <td>
                            <span class="alert-priority-badge {{ produit.statut }}">
                                {% if produit.statut == 'critique' %}
                                <i class="bi bi-exclamation-triangle-fill"></i> Critique
                                {% elif produit.statut == 'faible' %}
                                <i class="bi bi-exclamation-circle-fill"></i> Faible
                                {% elif produit.statut == 'surstock' %}
                                <i class="bi bi-archive-fill"></i> Surstock
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if produit.image_url %}
                                <img src="{{ produit.image_url }}" class="me-2 rounded" width="40" height="40" alt="{{ produit.designation }}">
                                {% else %}
                                <div class="me-2 rounded bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px">
                                    <i class="bi bi-box text-secondary"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <strong>{{ produit.designation or produit.produits }}</strong>
                                    <br><small class="text-muted">{{ produit.categorie or 'Non cat√©goris√©' }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="product-reference">{{ produit.reference }}</span>
                            {% if produit.reference_fournisseur %}
                            <br><small class="text-muted">R√©f. F: {{ produit.reference_fournisseur }}</small>
                            {% endif %}
                        </td>
                        <td>{{ produit.fournisseur or '-' }}</td>
                        <td>{{ produit.emplacement or '-' }}</td>
                        <td>
                            <span class="badge bg-light text-dark fs-6">
                                <i class="bi bi-box-seam"></i> {{ produit.quantite }}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">
                                Min: <strong>{{ produit.stock_min or 0 }}</strong>
                                {% if produit.stock_max %}
                                <br>Max: <strong>{{ produit.stock_max }}</strong>
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            <small>
                                {% if produit.statut == 'critique' %}
                                {% if produit.stock_max %}
                                <i class="bi bi-cart-plus text-danger"></i> <strong>{{ produit.stock_max - produit.quantite }} unit√©s</strong>
                                {% else %}
                                <i class="bi bi-exclamation-triangle text-danger"></i> Action urgente
                                {% endif %}
                                {% elif produit.statut == 'faible' %}
                                {% if produit.stock_max %}
                                <i class="bi bi-cart-plus text-warning"></i> <strong>{{ produit.stock_max - produit.quantite }} unit√©s</strong>
                                {% else %}
                                <i class="bi bi-exclamation-circle text-warning"></i> √Ä surveiller
                                {% endif %}
                                {% elif produit.statut == 'surstock' %}
                                {% if produit.stock_max %}
                                <i class="bi bi-info-circle text-info"></i> Exc√©dent: <strong>{{ produit.quantite - produit.stock_max }}</strong>
                                {% else %}
                                <i class="bi bi-archive text-info"></i> Stock √©lev√©
                                {% endif %}
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            <a href="/produit/{{ produit.reference }}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye"></i> D√©tails
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination (bas) -->
    {% if total_pages > 1 %}
    <nav aria-label="Navigation des alertes" class="my-4">
        <ul class="pagination pagination-sm justify-content-center">
            <!-- Premi√®re page -->
            {% if current_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
            </li>
            {% endif %}
            
            <!-- Page pr√©c√©dente -->
            {% if current_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ current_page - 1 }}{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            <!-- Pages num√©rot√©es -->
            {% set start_page = [current_page - 2, 1]|max %}
            {% set end_page = [current_page + 2, total_pages]|min %}
            
            {% for page_num in range(start_page, end_page + 1) %}
            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                <a class="page-link" href="?page={{ page_num }}{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    {{ page_num }}
                </a>
            </li>
            {% endfor %}

            <!-- Page suivante -->
            {% if current_page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ current_page + 1 }}{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
            
            <!-- Derni√®re page -->
            {% if current_page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ total_pages }}{% if fournisseur_filtre and fournisseur_filtre != 'tous' %}&fournisseur={{ fournisseur_filtre }}{% endif %}">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    <!-- Section d'export -->
    <div class="export-section">
        <h6><i class="bi bi-download"></i> Exporter les alertes</h6>
        <div class="row g-2">
            <div class="col-6 col-md-3">
                <button
                    class="btn btn-outline-success w-100"
                    onclick="exportToCSV()"
                >
                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button
                    class="btn btn-outline-primary w-100"
                    onclick="exportToExcel()"
                >
                    <i class="bi bi-file-earmark-excel"></i> Excel
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button
                    class="btn btn-outline-info w-100"
                    onclick="exportToPDF()"
                >
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button
                    class="btn btn-outline-secondary w-100"
                    onclick="printAlerts()"
                >
                    <i class="bi bi-printer"></i> Imprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de g√©n√©ration de bon de commande -->
    <div class="modal fade" id="bonCommandeModal" tabindex="-1" aria-labelledby="bonCommandeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bonCommandeModalLabel">
                        <i class="bi bi-cart-plus"></i> G√©n√©rer Bon de commande
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="fournisseurSelect" class="form-label fw-bold">
                                <i class="bi bi-building"></i> S√©lectionner le fournisseur
                            </label>
                            <select class="form-select" id="fournisseurSelect" onchange="updatePreview()">
                                <option value="">-- Choisir un fournisseur --</option>
                                {% for fournisseur in fournisseurs %}
                                <option value="{{ fournisseur.nom_fournisseur }}">
                                    {{ fournisseur.nom_fournisseur }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="dateLivraison" class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> Date de livraison souhait√©e
                            </label>
                            <input type="date" class="form-control" id="dateLivraison" min="{{ moment().format('YYYY-MM-DD') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-info-circle"></i> Informations
                            </label>
                            <div class="alert alert-info mb-0 p-2">
                                <small>
                                    Vous pouvez modifier les quantit√©s et s√©lectionner les produits √† commander.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="previewSection" class="mt-4" style="display: none;">
                        <h6><i class="bi bi-eye"></i> Aper√ßu des produits √† commander</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" id="selectAll" onchange="toggleAllProducts()" title="S√©lectionner tout">
                                        </th>
                                        <th>R√©f. Fournisseur</th>
                                        <th>Produit</th>
                                        <th>R√©f. PROFERM</th>
                                        <th>√âtat du stock</th>
                                        <th style="width: 100px;">Quantit√©</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                                <tfoot>
                                    <tr class="fw-bold bg-light">
                                        <td colspan="5" class="text-end">Total produits s√©lectionn√©s :</td>
                                        <td id="totalProduits">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="ajouterArticleSupplementaire()">
                                    <i class="bi bi-plus-circle"></i> Ajouter un article suppl√©mentaire
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Annuler
                    </button>
                    <button type="button" class="btn btn-success" onclick="generateBonCommande()" id="generateBtn" disabled>
                        <i class="bi bi-file-earmark-pdf"></i> G√©n√©rer le PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter un article suppl√©mentaire -->
    <div class="modal fade" id="ajouterArticleModal" tabindex="-1" aria-labelledby="ajouterArticleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ajouterArticleModalLabel">
                        <i class="bi bi-plus-circle"></i> Ajouter un article suppl√©mentaire
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="searchArticle" class="form-label fw-bold">
                            <i class="bi bi-search"></i> Rechercher un article
                        </label>
                        <input type="text" class="form-control" id="searchArticle" placeholder="Tapez le nom ou la r√©f√©rence de l'article..." onkeyup="rechercherArticles()">
                    </div>
                    
                    <div id="articlesDisponibles" style="display: none;">
                        <h6>Articles disponibles :</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>R√©f. Fournisseur</th>
                                        <th>Produit</th>
                                        <th>R√©f. PROFERM</th>
                                        <th>Stock actuel</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="articlesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="aucunArticle" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Aucun article trouv√©. Essayez avec d'autres mots-cl√©s.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bouton d'action flottant -->
    <div
        class="position-fixed bottom-0 end-0 p-3"
        style="z-index: 1000; bottom: 100px !important"
    >
        <div class="btn-group-vertical">
            <a
                href="{{ url_for('magasin') }}"
                class="btn btn-primary btn-lg rounded-circle mb-2"
                style="width: 60px; height: 60px"
                title="Voir le magasin"
            >
                <i class="bi bi-shop"></i>
            </a>
            <button
                class="btn btn-success btn-lg rounded-circle"
                onclick="refreshData()"
                style="width: 60px; height: 60px"
                title="Actualiser"
            >
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    function filterByFournisseur() {
        const fournisseur = document.getElementById('fournisseurFilter').value;
        const currentUrl = new URL(window.location);
        
        // Retourner √† la page 1 lors du changement de fournisseur
        currentUrl.searchParams.set('page', '1');
        
        if (fournisseur === 'tous') {
            currentUrl.searchParams.delete('fournisseur');
        } else {
            currentUrl.searchParams.set('fournisseur', fournisseur);
        }
        
        window.location.href = currentUrl.toString();
    }

    function refreshData() {
        location.reload();
    }

    function exportToCSV() {
        const alertes = [];

        // Collecter toutes les alertes
        document.querySelectorAll(".alert-card").forEach((card) => {
            const title = card.querySelector(".card-title").textContent;
            const reference = card
                .querySelector(".text-muted small")
                .textContent.split("|")[0]
                .replace("üÜî ", "")
                .trim();
            const emplacement = card
                .querySelector(".text-muted small")
                .textContent.split("|")[1]
                .replace("üìç ", "")
                .trim();
            const fournisseur = card
                .querySelector(".text-muted:last-of-type small")
                .textContent.replace("üè™ ", "")
                .trim();
            const badge = card.querySelector(".alert-badge").textContent.trim();
            const stock = card
                .querySelector(".fw-bold")
                .textContent.split("/")[0]
                .trim();
            const seuil = card
                .querySelector(".fw-bold")
                .textContent.split("/")[1]
                .trim();

            alertes.push({
                produit: title,
                reference: reference,
                emplacement: emplacement,
                fournisseur: fournisseur,
                statut: badge,
                stock_actuel: stock,
                seuil: seuil,
            });
        });

        if (alertes.length === 0) {
            showAlert("Aucune alerte √† exporter", "info");
            return;
        }

        let csv =
            "Produit,R√©f√©rence,Emplacement,Fournisseur,Statut,Stock Actuel,Seuil\n";

        alertes.forEach((alerte) => {
            csv += `"${alerte.produit}","${alerte.reference}","${alerte.emplacement}","${alerte.fournisseur}","${alerte.statut}","${alerte.stock_actuel}","${alerte.seuil}"\n`;
        });

        downloadFile(csv, "alertes_stock.csv", "text/csv");
        showAlert("Export CSV termin√©", "success");
    }

    function exportToExcel() {
        showAlert("Export Excel en cours de d√©veloppement", "info");
    }

    function exportToPDF() {
        showAlert("Export PDF en cours de d√©veloppement", "info");
    }

    function printAlerts() {
        window.print();
    }

    function downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Auto-refresh toutes les 5 minutes
    setInterval(function () {
        const lastRefresh = localStorage.getItem("lastAlertRefresh");
        const now = Date.now();

        if (!lastRefresh || now - parseInt(lastRefresh) > 300000) {
            // 5 minutes
            localStorage.setItem("lastAlertRefresh", now.toString());

            // Afficher une notification discr√®te
            showAlert("Actualisation automatique des alertes", "info");

            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    }, 300000); // V√©rifier toutes les 5 minutes

    // Fonction utilitaire pour afficher des alertes
    function showAlert(message, type = 'info') {
        const alertClass = type === 'error' ? 'danger' : type;
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${alertClass} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Donn√©es des produits pour le bon de commande
    const produitsData = {{ produits | tojson }};

    // Initialisation de la page
    document.addEventListener('DOMContentLoaded', function() {
        // Restaurer la vue pr√©f√©r√©e depuis localStorage
        const savedView = localStorage.getItem('alertesView');
        if (savedView === 'table') {
            document.getElementById('viewToggle').checked = true;
            toggleView();
        }
    });

    // Fonction pour basculer entre les vues
    function toggleView() {
        const tilesView = document.getElementById("tilesView");
        const tableView = document.getElementById("tableView");
        const viewToggle = document.getElementById("viewToggle");

        if (viewToggle.checked) {
            // Basculer vers la vue tableau
            tilesView.classList.add("d-none");
            tableView.classList.remove("d-none");
            localStorage.setItem("alertesView", "table");
        } else {
            // Basculer vers la vue tuiles
            tilesView.classList.remove("d-none");
            tableView.classList.add("d-none");
            localStorage.setItem("alertesView", "tiles");
        }
    }

    // Fonction pour ajouter un produit au bon de commande
    function addToBonCommande(reference) {
        // Trouver le produit dans les donn√©es
        const produit = produitsData.find(p => p.reference === reference);
        if (produit) {
            // Ouvrir la modal et pr√©-s√©lectionner le fournisseur
            const modal = new bootstrap.Modal(document.getElementById('bonCommandeModal'));
            modal.show();
            
            // Pr√©-s√©lectionner le fournisseur si disponible
            const fournisseurSelect = document.getElementById('fournisseurSelect');
            if (produit.fournisseur && fournisseurSelect) {
                fournisseurSelect.value = produit.fournisseur;
                updatePreview();
            }
        }
    }

    // Ouvrir la modal de bon de commande
    function openBonCommandeModal() {
        const modal = new bootstrap.Modal(document.getElementById('bonCommandeModal'));
        modal.show();
    }

    // Mettre √† jour l'aper√ßu selon le fournisseur s√©lectionn√©
    function updatePreview() {
        const fournisseurSelect = document.getElementById('fournisseurSelect');
        const selectedFournisseur = fournisseurSelect.value;
        const previewSection = document.getElementById('previewSection');
        const previewTableBody = document.getElementById('previewTableBody');
        const generateBtn = document.getElementById('generateBtn');
        const totalGeneral = document.getElementById('totalGeneral');

        if (!selectedFournisseur) {
            previewSection.style.display = 'none';
            generateBtn.disabled = true;
            return;
        }

        // Filtrer les produits du fournisseur s√©lectionn√© qui sont en alerte
        const produitsACommander = produitsData.filter(produit => 
            produit.fournisseur === selectedFournisseur && 
            (produit.statut === 'critique' || produit.statut === 'faible')
        );

        if (produitsACommander.length === 0) {
            previewSection.style.display = 'none';
            generateBtn.disabled = true;
            showAlert(`Aucun produit en alerte pour le fournisseur ${selectedFournisseur}`, 'warning');
            return;
        }

        // Construire le tableau d'aper√ßu
        let tableHTML = '';

        produitsACommander.forEach((produit, index) => {
            const stockActuel = produit.quantite || 0;
            const stockMax = produit.stock_max || 100;
            const qteACommander = Math.max(0, stockMax - stockActuel);

            // D√©terminer l'√©tat du stock avec badge color√©
            let etatStock = '';
            if (produit.statut === 'critique') {
                etatStock = '<span class="badge bg-danger"><i class="bi bi-exclamation-triangle-fill"></i> Critique</span>';
            } else if (produit.statut === 'faible') {
                etatStock = '<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle-fill"></i> Bient√¥t en rupture</span>';
            } else {
                etatStock = '<span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> Normal</span>';
            }

            tableHTML += `
                <tr data-product-index="${index}">
                    <td class="text-center">
                        <input type="checkbox" class="product-checkbox" data-index="${index}" checked onchange="updateTotalProducts()">
                    </td>
                    <td>${produit.reference_fournisseur || '-'}</td>
                    <td>${produit.designation || produit.produits}</td>
                    <td>${produit.reference}</td>
                    <td>${etatStock}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm quantity-input" 
                               data-index="${index}" value="${qteACommander}" min="1" max="999" 
                               onchange="updateTotalProducts()" style="width: 80px;">
                    </td>
                </tr>
            `;
        });

        previewTableBody.innerHTML = tableHTML;
        updateTotalProducts();
        previewSection.style.display = 'block';
        generateBtn.disabled = false;
    }

    // Fonction pour s√©lectionner/d√©s√©lectionner tous les produits
    function toggleAllProducts() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const productCheckboxes = document.querySelectorAll('.product-checkbox');
        
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        
        updateTotalProducts();
    }

    // Fonction pour mettre √† jour le total des produits s√©lectionn√©s
    function updateTotalProducts() {
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        const totalProduits = document.getElementById('totalProduits');
        const generateBtn = document.getElementById('generateBtn');
        
        totalProduits.textContent = checkedBoxes.length;
        
        // D√©sactiver le bouton si aucun produit s√©lectionn√©
        if (checkedBoxes.length === 0) {
            generateBtn.disabled = true;
        } else {
            generateBtn.disabled = false;
        }
        
        // Mettre √† jour la case "S√©lectionner tout"
        const selectAllCheckbox = document.getElementById('selectAll');
        const allCheckboxes = document.querySelectorAll('.product-checkbox');
        selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedBoxes.length === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
    }

    // G√©n√©rer le bon de commande PDF
    function generateBonCommande() {
        const fournisseurSelect = document.getElementById('fournisseurSelect');
        const selectedFournisseur = fournisseurSelect.value;
        const dateLivraison = document.getElementById('dateLivraison').value;

        if (!selectedFournisseur) {
            showAlert('Veuillez s√©lectionner un fournisseur', 'error');
            return;
        }

        // R√©cup√©rer les produits s√©lectionn√©s avec leurs quantit√©s
        const selectedProducts = [];
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        
        if (checkedBoxes.length === 0) {
            showAlert('Veuillez s√©lectionner au moins un produit', 'warning');
            return;
        }

        checkedBoxes.forEach(checkbox => {
            const index = parseInt(checkbox.dataset.index);
            const quantityInput = document.querySelector(`.quantity-input[data-index="${index}"]`);
            const quantity = parseInt(quantityInput.value) || 0;
            
            if (quantity > 0) {
                // V√©rifier si c'est un article suppl√©mentaire
                const ligne = checkbox.closest('tr');
                const estSupplementaire = ligne.getAttribute('data-supplementaire') === 'true';
                
                if (estSupplementaire) {
                    // Trouver l'article suppl√©mentaire correspondant
                    const articleSupplementaire = articlesSupplementairesAjoutes.find(item => item.index === index);
                    if (articleSupplementaire) {
                        selectedProducts.push({
                            index: index,
                            quantity: quantity,
                            supplementaire: true,
                            article: articleSupplementaire.article
                        });
                    }
                } else {
                    // Article normal (en alerte)
                    selectedProducts.push({
                        index: index,
                        quantity: quantity,
                        supplementaire: false
                    });
                }
            }
        });

        if (selectedProducts.length === 0) {
            showAlert('Veuillez saisir des quantit√©s valides', 'warning');
            return;
        }

        // Afficher un spinner de chargement
        const generateBtn = document.getElementById('generateBtn');
        const originalHTML = generateBtn.innerHTML;
        generateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> G√©n√©ration...';
        generateBtn.disabled = true;

        // Appel API pour g√©n√©rer le PDF
        fetch('/api/generer-bon-commande', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                fournisseur: selectedFournisseur,
                dateLivraison: dateLivraison,
                selectedProducts: selectedProducts
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur lors de la g√©n√©ration du PDF');
            }
            return response.blob();
        })
        .then(blob => {
            // T√©l√©charger le PDF
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `bon_commande_${selectedFournisseur}_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showAlert('Bon de commande g√©n√©r√© avec succ√®s !', 'success');
            
            // Fermer la modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('bonCommandeModal'));
            modal.hide();
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur lors de la g√©n√©ration du bon de commande', 'error');
        })
        .finally(() => {
            // Restaurer le bouton
            generateBtn.innerHTML = originalHTML;
            generateBtn.disabled = false;
        });
    };

    // Variables globales pour les articles suppl√©mentaires
    let todosLesArticlesFournisseur = [];
    let articlesSupplementairesAjoutes = [];
    let prochainIndexArticle = 10000; // Index √©lev√© pour √©viter les conflits

    // Fonction pour ouvrir la modal d'ajout d'article suppl√©mentaire
    function ajouterArticleSupplementaire() {
        const fournisseurSelect = document.getElementById('fournisseurSelect');
        const selectedFournisseur = fournisseurSelect.value;
        
        if (!selectedFournisseur) {
            showAlert('Veuillez d\'abord s√©lectionner un fournisseur', 'warning');
            return;
        }
        
        // Charger tous les articles du fournisseur si pas d√©j√† fait
        if (todosLesArticlesFournisseur.length === 0) {
            chargerTousLesArticlesFournisseur(selectedFournisseur);
        }
        
        // R√©initialiser la recherche
        document.getElementById('searchArticle').value = '';
        document.getElementById('articlesDisponibles').style.display = 'none';
        document.getElementById('aucunArticle').style.display = 'none';
        
        // Ouvrir la modal
        const modal = new bootstrap.Modal(document.getElementById('ajouterArticleModal'));
        modal.show();
    }

    // Fonction pour charger tous les articles du fournisseur
    function chargerTousLesArticlesFournisseur(fournisseur) {
        fetch(`/api/produits-fournisseur/${encodeURIComponent(fournisseur)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    todosLesArticlesFournisseur = data.produits;
                } else {
                    showAlert('Erreur lors du chargement des articles: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showAlert('Erreur lors du chargement des articles', 'error');
            });
    }

    // Fonction de recherche d'articles
    function rechercherArticles() {
        const searchTerm = document.getElementById('searchArticle').value.toLowerCase().trim();
        const articlesDisponibles = document.getElementById('articlesDisponibles');
        const aucunArticle = document.getElementById('aucunArticle');
        const articlesTableBody = document.getElementById('articlesTableBody');
        
        if (searchTerm.length < 2) {
            articlesDisponibles.style.display = 'none';
            aucunArticle.style.display = 'none';
            return;
        }
        
        // Filtrer les articles selon le terme de recherche
        const articlesFiltres = todosLesArticlesFournisseur.filter(article => {
            const nom = (article.designation || article.produits || '').toLowerCase();
            const reference = (article.reference || '').toLowerCase();
            const referenceFournisseur = (article.reference_fournisseur || '').toLowerCase();
            
            return nom.includes(searchTerm) || 
                   reference.includes(searchTerm) || 
                   referenceFournisseur.includes(searchTerm);
        });
        
        if (articlesFiltres.length === 0) {
            articlesDisponibles.style.display = 'none';
            aucunArticle.style.display = 'block';
            return;
        }
        
        // Construire le tableau des r√©sultats
        let tableHTML = '';
        articlesFiltres.forEach((article, index) => {
            // V√©rifier si l'article n'est pas d√©j√† dans la liste
            const dejaAjoute = articlesSupplementairesAjoutes.some(ajout => 
                ajout.reference === article.reference
            );
            
            if (!dejaAjoute) {
                const stockActuel = article.quantite || 0;
                const stockStatus = stockActuel > (article.stock_min || 0) ? 'success' : 'warning';
                
                tableHTML += `
                    <tr>
                        <td>${article.reference_fournisseur || '-'}</td>
                        <td>${article.designation || article.produits}</td>
                        <td>${article.reference}</td>
                        <td>
                            <span class="badge bg-${stockStatus}">${stockActuel}</span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" onclick="ajouterCetArticle(${index}, '${article.reference}')">
                                <i class="bi bi-plus"></i> Ajouter
                            </button>
                        </td>
                    </tr>
                `;
            }
        });
        
        if (tableHTML === '') {
            articlesDisponibles.style.display = 'none';
            aucunArticle.style.display = 'block';
        } else {
            articlesTableBody.innerHTML = tableHTML;
            articlesDisponibles.style.display = 'block';
            aucunArticle.style.display = 'none';
        }
    }

    // Fonction pour ajouter un article sp√©cifique √† la commande
    function ajouterCetArticle(index, reference) {
        const searchTerm = document.getElementById('searchArticle').value.toLowerCase().trim();
        const articlesFiltres = todosLesArticlesFournisseur.filter(article => {
            const nom = (article.designation || article.produits || '').toLowerCase();
            const referenceArticle = (article.reference || '').toLowerCase();
            const referenceFournisseur = (article.reference_fournisseur || '').toLowerCase();
            
            return nom.includes(searchTerm) || 
                   referenceArticle.includes(searchTerm) || 
                   referenceFournisseur.includes(searchTerm);
        });
        
        if (index >= 0 && index < articlesFiltres.length) {
            const article = articlesFiltres[index];
            
            // Ajouter l'article √† la liste des articles suppl√©mentaires
            const nouvelIndex = prochainIndexArticle++;
            articlesSupplementairesAjoutes.push({
                index: nouvelIndex,
                reference: article.reference,
                article: article
            });
            
            // Ajouter une ligne au tableau du bon de commande
            const previewTableBody = document.getElementById('previewTableBody');
            const qteRecommandee = article.qte_recommandee || 1;
            
            const nouvelleLigne = document.createElement('tr');
            nouvelleLigne.setAttribute('data-product-index', nouvelIndex);
            nouvelleLigne.setAttribute('data-supplementaire', 'true');
            nouvelleLigne.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="product-checkbox" data-index="${nouvelIndex}" checked onchange="updateTotalProducts()">
                </td>
                <td>${article.reference_fournisseur || '-'}</td>
                <td>
                    ${article.designation || article.produits}
                    <small class="text-muted d-block">
                        <i class="bi bi-plus-circle text-primary"></i> Article suppl√©mentaire
                    </small>
                </td>
                <td>${article.reference}</td>
                <td><span class="badge bg-info"><i class="bi bi-plus-circle"></i> Ajout manuel</span></td>
                <td>
                    <input type="number" class="form-control form-control-sm quantity-input" 
                           data-index="${nouvelIndex}" value="${qteRecommandee}" min="1" max="999" 
                           onchange="updateTotalProducts()" style="width: 80px;">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="supprimerArticleSupplementaire(${nouvelIndex})" title="Supprimer">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            
            previewTableBody.appendChild(nouvelleLigne);
            
            // Mettre √† jour le total
            updateTotalProducts();
            
            // Fermer la modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('ajouterArticleModal'));
            modal.hide();
            
            showAlert(`Article "${article.designation || article.produits}" ajout√© √† la commande`, 'success');
        }
    }

    // Fonction pour supprimer un article suppl√©mentaire
    function supprimerArticleSupplementaire(index) {
        // Supprimer la ligne du tableau
        const ligne = document.querySelector(`tr[data-product-index="${index}"]`);
        if (ligne) {
            ligne.remove();
        }
        
        // Supprimer de la liste des articles suppl√©mentaires
        articlesSupplementairesAjoutes = articlesSupplementairesAjoutes.filter(item => item.index !== index);
        
        // Mettre √† jour le total
        updateTotalProducts();
        
        showAlert('Article supprim√© de la commande', 'info');
    }

    // Animation d'entr√©e pour les cartes d'alerte
    document.addEventListener("DOMContentLoaded", function () {
        const cards = document.querySelectorAll(".alert-card");
        cards.forEach((card, index) => {
            card.style.opacity = "0";
            card.style.transform = "translateX(-20px)";

            setTimeout(() => {
                card.style.transition = "all 0.5s ease";
                card.style.opacity = "1";
                card.style.transform = "translateX(0)";
            }, index * 100);
        });
    });
</script>
{% endblock %}
