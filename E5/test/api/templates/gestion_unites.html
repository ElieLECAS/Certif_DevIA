{% extends "base.html" %} {% block title %}Gestion des Unités{% endblock %} {%
block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="h3 mb-3">
                <i class="bi bi-rulers text-primary"></i>
                Gestion des Unités
            </h1>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-box"></i> Unités de Stockage
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h3 class="text-primary">
                                {{ stats_stockage.total }}
                            </h3>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-success">
                                {{ stats_stockage.actives }}
                            </h3>
                            <small class="text-muted">Actives</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-info">
                                {{ stats_stockage.types }}
                            </h3>
                            <small class="text-muted">Types</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-truck"></i> Unités de Commande
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h3 class="text-success">
                                {{ stats_commande.total }}
                            </h3>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-success">
                                {{ stats_commande.actives }}
                            </h3>
                            <small class="text-muted">Actives</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-info">
                                {{ stats_commande.types }}
                            </h3>
                            <small class="text-muted">Types</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglets -->
    <div class="card">
        <div class="card-header">
            <ul
                class="nav nav-tabs card-header-tabs"
                id="uniteTabs"
                role="tablist"
            >
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link active"
                        id="stockage-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#stockage"
                        type="button"
                        role="tab"
                    >
                        <i class="bi bi-box"></i> Unités de Stockage
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="commande-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#commande"
                        type="button"
                        role="tab"
                    >
                        <i class="bi bi-truck"></i> Unités de Commande
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="uniteTabContent">
                <!-- Onglet Unités de Stockage -->
                <div
                    class="tab-pane fade show active"
                    id="stockage"
                    role="tabpanel"
                >
                    <div
                        class="d-flex justify-content-between align-items-center mb-3"
                    >
                        <h5 class="mb-0">Unités de Stockage</h5>
                        <button
                            class="btn btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#modalStockage"
                        >
                            <i class="bi bi-plus-circle"></i> Nouvelle Unité
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Code</th>
                                    <th>Nom</th>
                                    <th>Symbole</th>
                                    <th>Type</th>
                                    <th>Facteur Conversion</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for unite in unites_stockage %}
                                <tr>
                                    <td>
                                        <strong>{{ unite.code_unite }}</strong>
                                    </td>
                                    <td>{{ unite.nom_unite }}</td>
                                    <td>
                                        <span class="badge bg-info"
                                            >{{ unite.symbole }}</span
                                        >
                                    </td>
                                    <td>{{ unite.type_unite or '-' }}</td>
                                    <td>
                                        {{ unite.facteur_conversion or '1.0000'
                                        }}
                                    </td>
                                    <td>
                                        {% if unite.statut == 'Actif' %}
                                        <span class="badge bg-success"
                                            >{{ unite.statut }}</span
                                        >
                                        {% else %}
                                        <span class="badge bg-secondary"
                                            >{{ unite.statut }}</span
                                        >
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button
                                                class="btn btn-outline-primary"
                                                onclick="modifierUniteStockage({{ unite.id }})"
                                            >
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button
                                                class="btn btn-outline-danger"
                                                onclick="supprimerUniteStockage({{ unite.id }})"
                                            >
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Onglet Unités de Commande -->
                <div class="tab-pane fade" id="commande" role="tabpanel">
                    <div
                        class="d-flex justify-content-between align-items-center mb-3"
                    >
                        <h5 class="mb-0">Unités de Commande</h5>
                        <button
                            class="btn btn-success"
                            data-bs-toggle="modal"
                            data-bs-target="#modalCommande"
                        >
                            <i class="bi bi-plus-circle"></i> Nouvelle Unité
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Code</th>
                                    <th>Nom</th>
                                    <th>Symbole</th>
                                    <th>Type</th>
                                    <th>Quantité Unitaire</th>
                                    <th>Facteur Conversion</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for unite in unites_commande %}
                                <tr>
                                    <td>
                                        <strong>{{ unite.code_unite }}</strong>
                                    </td>
                                    <td>{{ unite.nom_unite }}</td>
                                    <td>
                                        <span class="badge bg-success"
                                            >{{ unite.symbole }}</span
                                        >
                                    </td>
                                    <td>{{ unite.type_unite or '-' }}</td>
                                    <td>
                                        {{ unite.quantite_unitaire or '1' }}
                                    </td>
                                    <td>
                                        {{ unite.facteur_conversion or '1.0000'
                                        }}
                                    </td>
                                    <td>
                                        {% if unite.statut == 'Actif' %}
                                        <span class="badge bg-success"
                                            >{{ unite.statut }}</span
                                        >
                                        {% else %}
                                        <span class="badge bg-secondary"
                                            >{{ unite.statut }}</span
                                        >
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button
                                                class="btn btn-outline-primary"
                                                onclick="console.log('Bouton cliqué pour ID:', {{ unite.id }}); modifierUniteCommande({{ unite.id }})"
                                            >
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button
                                                class="btn btn-outline-danger"
                                                onclick="supprimerUniteCommande({{ unite.id }})"
                                            >
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouvelle Unité de Stockage -->
<div class="modal fade" id="modalStockage" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nouvelle Unité de Stockage</h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="formStockage">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Code Unité *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="code_unite"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nom Unité *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="nom_unite"
                                    required
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Symbole *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="symbole"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Type Unité</label>
                                <select class="form-select" name="type_unite">
                                    <option value="">Sélectionner</option>
                                    <option value="Poids">Poids</option>
                                    <option value="Volume">Volume</option>
                                    <option value="Longueur">Longueur</option>
                                    <option value="Quantité">Quantité</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label"
                                    >Facteur Conversion</label
                                >
                                <input
                                    type="number"
                                    class="form-control"
                                    name="facteur_conversion"
                                    step="0.0001"
                                    value="1.0000"
                                />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">Créer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nouvelle Unité de Commande -->
<div class="modal fade" id="modalCommande" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nouvelle Unité de Commande</h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="formCommande">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Code Unité *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="code_unite"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nom Unité *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="nom_unite"
                                    required
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Symbole *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="symbole"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Type Unité</label>
                                <select class="form-select" name="type_unite">
                                    <option value="">Sélectionner</option>
                                    <option value="Conditionnement">
                                        Conditionnement
                                    </option>
                                    <option value="Emballage">Emballage</option>
                                    <option value="Lot">Lot</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label"
                                    >Quantité Unitaire</label
                                >
                                <input
                                    type="number"
                                    class="form-control"
                                    name="quantite_unitaire"
                                    value="1"
                                    min="1"
                                />
                                <small class="text-muted"
                                    >Ex: 1 carton = 5 pièces</small
                                >
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"
                                    >Facteur Conversion</label
                                >
                                <input
                                    type="number"
                                    class="form-control"
                                    name="facteur_conversion"
                                    step="0.0001"
                                    value="1.0000"
                                />
                                <small class="text-muted"
                                    >Pour conversion vers unité de
                                    stockage</small
                                >
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-success">Créer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modification Unité -->
<div class="modal fade" id="modalModification" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalModificationTitle">
                    Modifier l'Unité
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="formModification">
                <div class="modal-body" id="modalModificationBody">
                    <!-- Le contenu sera généré dynamiquement -->
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Modifier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Soumission des formulaires de création
        document
            .getElementById("formStockage")
            .addEventListener("submit", async function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = Object.fromEntries(formData);

                try {
                    const response = await fetch("/api/unites-stockage", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });

                    const result = await response.json();
                    if (result.success) {
                        location.reload();
                    } else {
                        alert("Erreur: " + result.message);
                    }
                } catch (error) {
                    alert("Erreur lors de la création: " + error.message);
                }
            });

        document
            .getElementById("formCommande")
            .addEventListener("submit", async function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = Object.fromEntries(formData);

                try {
                    const response = await fetch("/api/unites-commande", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });

                    const result = await response.json();
                    if (result.success) {
                        location.reload();
                    } else {
                        alert("Erreur: " + result.message);
                    }
                } catch (error) {
                    alert("Erreur lors de la création: " + error.message);
                }
            });
    });

    // Fonctions pour les actions
    async function modifierUniteStockage(id) {
        try {
            // Récupérer les données de l'unité
            const response = await fetch(`/api/unites-stockage/${id}`);
            const result = await response.json();

            if (result.success) {
                const unite = result.unite;

                // Remplir le modal de modification
                document.getElementById("modalModificationTitle").textContent =
                    "Modifier l'Unité de Stockage";
                document.getElementById("modalModificationBody").innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Code Unité *</label>
                            <input type="text" class="form-control" name="code_unite" value="${
                                unite.code_unite
                            }" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nom Unité *</label>
                            <input type="text" class="form-control" name="nom_unite" value="${
                                unite.nom_unite
                            }" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Symbole *</label>
                            <input type="text" class="form-control" name="symbole" value="${
                                unite.symbole
                            }" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Type Unité</label>
                            <select class="form-select" name="type_unite">
                                <option value="">Sélectionner</option>
                                <option value="Poids" ${
                                    unite.type_unite === "Poids"
                                        ? "selected"
                                        : ""
                                }>Poids</option>
                                <option value="Volume" ${
                                    unite.type_unite === "Volume"
                                        ? "selected"
                                        : ""
                                }>Volume</option>
                                <option value="Longueur" ${
                                    unite.type_unite === "Longueur"
                                        ? "selected"
                                        : ""
                                }>Longueur</option>
                                <option value="Quantité" ${
                                    unite.type_unite === "Quantité"
                                        ? "selected"
                                        : ""
                                }>Quantité</option>
                                <option value="Autre" ${
                                    unite.type_unite === "Autre"
                                        ? "selected"
                                        : ""
                                }>Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Facteur Conversion</label>
                            <input type="number" class="form-control" name="facteur_conversion" step="0.0001" value="${
                                unite.facteur_conversion || 1.0
                            }">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Statut</label>
                    <select class="form-select" name="statut">
                        <option value="Actif" ${
                            unite.statut === "Actif" ? "selected" : ""
                        }>Actif</option>
                        <option value="Inactif" ${
                            unite.statut === "Inactif" ? "selected" : ""
                        }>Inactif</option>
                    </select>
                </div>
            `;

                // Gérer la soumission du formulaire
                document.getElementById("formModification").onsubmit =
                    async function (e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData);

                        try {
                            const updateResponse = await fetch(
                                `/api/unites-stockage/${id}`,
                                {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(data),
                                }
                            );

                            const updateResult = await updateResponse.json();
                            if (updateResult.success) {
                                location.reload();
                            } else {
                                alert("Erreur: " + updateResult.message);
                            }
                        } catch (error) {
                            alert(
                                "Erreur lors de la modification: " +
                                    error.message
                            );
                        }
                    };

                // Afficher le modal
                new bootstrap.Modal(
                    document.getElementById("modalModification")
                ).show();
            }
        } catch (error) {
            alert("Erreur lors du chargement des données: " + error.message);
        }
    }

    async function supprimerUniteStockage(id) {
        if (
            confirm(
                "Êtes-vous sûr de vouloir supprimer cette unité de stockage ?"
            )
        ) {
            try {
                const response = await fetch(`/api/unites-stockage/${id}`, {
                    method: "DELETE",
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert("Erreur: " + result.message);
                }
            } catch (error) {
                alert("Erreur lors de la suppression: " + error.message);
            }
        }
    }

    async function modifierUniteCommande(id) {
        console.log("modifierUniteCommande appelée avec ID:", id);
        try {
            // Récupérer les données de l'unité
            const response = await fetch(`/api/unites-commande/${id}`);
            const result = await response.json();
            console.log("Réponse API:", result);

            if (result.success) {
                const unite = result.unite;

                // Remplir le modal de modification
                document.getElementById("modalModificationTitle").textContent =
                    "Modifier l'Unité de Commande";
                // Calculer la conversion pour l'affichage
                const facteur = unite.facteur_conversion || 1.0;
                const quantiteUnitaire = unite.quantite_unitaire || 1;
                const conversionText =
                    facteur > 1
                        ? `1 ${unite.symbole} = ${facteur} pce`
                        : `${quantiteUnitaire} ${unite.symbole} = ${quantiteUnitaire} pce`;

                document.getElementById("modalModificationBody").innerHTML = `
                <!-- Conversion Info -->
                <div class="alert alert-info mb-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-calculator me-2"></i>
                        <strong>Conversion: ${conversionText}</strong>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Code Unité *</label>
                            <input type="text" class="form-control" name="code_unite" value="${
                                unite.code_unite
                            }" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nom Unité *</label>
                            <input type="text" class="form-control" name="nom_unite" value="${
                                unite.nom_unite
                            }" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Symbole *</label>
                            <input type="text" class="form-control" name="symbole" value="${
                                unite.symbole
                            }" required onchange="updateConversionCommande()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Type Unité</label>
                            <select class="form-select" name="type_unite">
                                <option value="">Sélectionner</option>
                                <option value="Conditionnement" ${
                                    unite.type_unite === "Conditionnement"
                                        ? "selected"
                                        : ""
                                }>Conditionnement</option>
                                <option value="Emballage" ${
                                    unite.type_unite === "Emballage"
                                        ? "selected"
                                        : ""
                                }>Emballage</option>
                                <option value="Lot" ${
                                    unite.type_unite === "Lot" ? "selected" : ""
                                }>Lot</option>
                                <option value="Autre" ${
                                    unite.type_unite === "Autre"
                                        ? "selected"
                                        : ""
                                }>Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Quantité Unitaire</label>
                            <input type="number" class="form-control" name="quantite_unitaire" value="${
                                unite.quantite_unitaire || 1
                            }" min="1" onchange="updateConversionCommande()">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Facteur Conversion</label>
                            <input type="number" class="form-control" name="facteur_conversion" step="0.0001" value="${
                                unite.facteur_conversion || 1.0
                            }" onchange="updateConversionCommande()">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Statut</label>
                            <select class="form-select" name="statut">
                                <option value="Actif" ${
                                    unite.statut === "Actif" ? "selected" : ""
                                }>Actif</option>
                                <option value="Inactif" ${
                                    unite.statut === "Inactif" ? "selected" : ""
                                }>Inactif</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

                // Gérer la soumission du formulaire
                document.getElementById("formModification").onsubmit =
                    async function (e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData);

                        try {
                            const updateResponse = await fetch(
                                `/api/unites-commande/${id}`,
                                {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(data),
                                }
                            );

                            const updateResult = await updateResponse.json();
                            if (updateResult.success) {
                                location.reload();
                            } else {
                                alert("Erreur: " + updateResult.message);
                            }
                        } catch (error) {
                            alert(
                                "Erreur lors de la modification: " +
                                    error.message
                            );
                        }
                    };

                // Afficher le modal
                console.log("Tentative d'affichage du modal");
                const modalElement =
                    document.getElementById("modalModification");
                console.log("Élément modal trouvé:", modalElement);
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                    console.log("Modal affiché");
                } else {
                    console.error("Élément modal non trouvé");
                    alert("Erreur: Modal non trouvé dans le DOM");
                }
            } else {
                console.error("Erreur API:", result.message);
                alert("Erreur API: " + result.message);
            }
        } catch (error) {
            console.error("Erreur dans modifierUniteCommande:", error);
            alert("Erreur lors du chargement des données: " + error.message);
        }
    }

    async function supprimerUniteCommande(id) {
        if (
            confirm(
                "Êtes-vous sûr de vouloir supprimer cette unité de commande ?"
            )
        ) {
            try {
                const response = await fetch(`/api/unites-commande/${id}`, {
                    method: "DELETE",
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert("Erreur: " + result.message);
                }
            } catch (error) {
                alert("Erreur lors de la suppression: " + error.message);
            }
        }
    }

    // Fonction pour mettre à jour la conversion en temps réel
    function updateConversionCommande() {
        try {
            const facteur =
                parseFloat(
                    document.querySelector('input[name="facteur_conversion"]')
                        .value
                ) || 1.0;
            const quantiteUnitaire =
                parseInt(
                    document.querySelector('input[name="quantite_unitaire"]')
                        .value
                ) || 1;
            const symbole =
                document.querySelector('input[name="symbole"]').value || "pce";

            const conversionText =
                facteur > 1
                    ? `1 ${symbole} = ${facteur} pce`
                    : `${quantiteUnitaire} ${symbole} = ${quantiteUnitaire} pce`;

            const alertElement = document.querySelector(".alert-info strong");
            if (alertElement) {
                alertElement.innerHTML = `Conversion: ${conversionText}`;
            }
        } catch (error) {
            console.log(
                "Erreur lors de la mise à jour de la conversion:",
                error
            );
        }
    }
</script>
{% endblock %}
