{% extends "base.html" %} {% block title %}Gestion des Utilisateurs{% endblock
%} {% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-people text-primary"></i>
                        Gestion des Utilisateurs
                    </h1>
                    <p class="text-muted mb-0">
                        Gérer les utilisateurs et leurs droits d'accès
                    </p>
                </div>
                <div class="btn-group">
                    <button
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#nouveauUtilisateurModal"
                    >
                        <i class="bi bi-plus-circle"></i> Nouvel Utilisateur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-primary">{{ stats.total }}</h5>
                    <p class="card-text">Total Utilisateurs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-success">{{ stats.actifs }}</h5>
                    <p class="card-text">Utilisateurs Actifs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-warning">{{ stats.admins }}</h5>
                    <p class="card-text">Administrateurs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">{{ stats.managers }}</h5>
                    <p class="card-text">Managers</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et recherche -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Rechercher</label>
                            <input
                                type="text"
                                class="form-control"
                                id="searchInput"
                                placeholder="Nom, email, username..."
                            />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Rôle</label>
                            <select class="form-select" id="roleFilter">
                                <option value="">Tous les rôles</option>
                                <option value="admin">Administrateur</option>
                                <option value="manager">Manager</option>
                                <option value="utilisateur">Utilisateur</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Statut</label>
                            <select class="form-select" id="statutFilter">
                                <option value="">Tous les statuts</option>
                                <option value="actif">Actif</option>
                                <option value="inactif">Inactif</option>
                                <option value="bloque">Bloqué</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des utilisateurs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table"></i> Liste des Utilisateurs
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table
                            class="table table-hover mb-0"
                            id="utilisateursTable"
                        >
                            <thead class="table-light">
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Statut</th>
                                    <th>Dernière connexion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for utilisateur in utilisateurs %}
                                <tr
                                    data-role="{{ utilisateur.role }}"
                                    data-statut="{{ utilisateur.statut }}"
                                    data-id="{{ utilisateur.id }}"
                                >
                                    <td>
                                        <div>
                                            <strong
                                                >{{ utilisateur.username
                                                }}</strong
                                            ><br />
                                            <small class="text-muted"
                                                >{{ utilisateur.nom_complet
                                                }}</small
                                            >
                                        </div>
                                    </td>
                                    <td>{{ utilisateur.email }}</td>
                                    <td>
                                        {% if utilisateur.role == 'admin' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-shield-fill"></i>
                                            Administrateur
                                        </span>
                                        {% elif utilisateur.role == 'manager' %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-person-check"></i>
                                            Manager
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-person"></i>
                                            Utilisateur
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if utilisateur.statut == 'actif' %}
                                        <span class="badge bg-success"
                                            >Actif</span
                                        >
                                        {% elif utilisateur.statut == 'inactif'
                                        %}
                                        <span class="badge bg-secondary"
                                            >Inactif</span
                                        >
                                        {% else %}
                                        <span class="badge bg-danger"
                                            >Bloqué</span
                                        >
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if utilisateur.derniere_connexion %}
                                        <small
                                            >{{
                                            format_datetime(utilisateur.derniere_connexion)
                                            }}</small
                                        >
                                        {% else %}
                                        <em class="text-muted"
                                            >Jamais connecté</em
                                        >
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button
                                                class="btn btn-outline-warning"
                                                onclick="modifierUtilisateur({{ utilisateur.id }})"
                                                title="Modifier"
                                            >
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            {% if utilisateur.id !=
                                            current_user.id %}
                                            <button
                                                class="btn btn-outline-danger"
                                                onclick="supprimerUtilisateur({{ utilisateur.id }}, '{{ utilisateur.username }}')"
                                                title="Supprimer"
                                            >
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouvel Utilisateur -->
<div class="modal fade" id="nouveauUtilisateurModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="bi bi-plus-circle text-primary"></i>
                    Nouvel Utilisateur
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="utilisateurForm">
                <div class="modal-body">
                    <input type="hidden" id="utilisateurId" name="id" />

                    <div class="row g-3">
                        <!-- Informations générales -->
                        <div class="col-12">
                            <h6 class="text-primary">
                                <i class="bi bi-person"></i> Informations
                                générales
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"
                                >Nom d'utilisateur *</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                id="username"
                                name="username"
                                required
                                placeholder="Nom d'utilisateur"
                            />
                            <div class="form-text">
                                Utilisé pour la connexion
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input
                                type="email"
                                class="form-control"
                                id="email"
                                name="email"
                                required
                                placeholder="email@exemple.com"
                            />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Nom complet *</label>
                            <input
                                type="text"
                                class="form-control"
                                id="nom_complet"
                                name="nom_complet"
                                required
                                placeholder="Nom et prénom complets"
                            />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Téléphone</label>
                            <input
                                type="tel"
                                class="form-control"
                                id="telephone"
                                name="telephone"
                                placeholder="Numéro de téléphone"
                            />
                        </div>

                        <!-- Sécurité -->
                        <div class="col-12 mt-4">
                            <h6 class="text-warning">
                                <i class="bi bi-shield-lock"></i> Sécurité
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                Mot de passe
                                <span id="passwordRequired">*</span>
                            </label>
                            <div class="input-group">
                                <input
                                    type="password"
                                    class="form-control"
                                    id="password"
                                    name="password"
                                    placeholder="Minimum 6 caractères"
                                />
                                <button
                                    class="btn btn-outline-secondary"
                                    type="button"
                                    onclick="togglePassword()"
                                >
                                    <i
                                        class="bi bi-eye"
                                        id="togglePasswordIcon"
                                    ></i>
                                </button>
                            </div>
                            <div class="form-text" id="passwordHelp">
                                Minimum 6 caractères. Laissez vide pour
                                conserver le mot de passe actuel lors de la
                                modification.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                Confirmer le mot de passe
                                <span id="confirmPasswordRequired">*</span>
                            </label>
                            <input
                                type="password"
                                class="form-control"
                                id="confirmPassword"
                                name="confirmPassword"
                                placeholder="Confirmer le mot de passe"
                            />
                        </div>

                        <!-- Droits -->
                        <div class="col-12 mt-4">
                            <h6 class="text-success">
                                <i class="bi bi-key"></i> Droits et permissions
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rôle *</label>
                            <select
                                class="form-select"
                                id="role"
                                name="role"
                                required
                            >
                                <option value="">Sélectionner un rôle</option>
                                <option value="utilisateur">Utilisateur</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Administrateur</option>
                            </select>
                            <div class="form-text">
                                <small>
                                    <strong>Utilisateur:</strong>
                                    Consultation<br />
                                    <strong>Manager:</strong> Gestion du
                                    stock<br />
                                    <strong>Admin:</strong> Tous les droits
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Statut</label>
                            <select
                                class="form-select"
                                id="statut"
                                name="statut"
                            >
                                <option value="actif">Actif</option>
                                <option value="inactif">Inactif</option>
                                <option value="bloque">Bloqué</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary"
                        id="btnSauvegarder"
                    >
                        <i class="bi bi-check-circle"></i> Sauvegarder
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger"></i>
                    Confirmer la suppression
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <div class="modal-body">
                <p>
                    Êtes-vous sûr de vouloir supprimer l'utilisateur
                    <strong id="deleteUserName"></strong> ?
                </p>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Cette action est irréversible.
                </p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Annuler
                </button>
                <button
                    type="button"
                    class="btn btn-danger"
                    id="confirmDeleteBtn"
                >
                    <i class="bi bi-trash"></i> Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Variables globales
        let currentUserId = null;
        let isEditMode = false;

        // Éléments DOM
        const searchInput = document.getElementById("searchInput");
        const roleFilter = document.getElementById("roleFilter");
        const statutFilter = document.getElementById("statutFilter");
        const utilisateursTable = document.getElementById("utilisateursTable");
        const utilisateurForm = document.getElementById("utilisateurForm");

        // Filtrage et recherche
        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRole = roleFilter.value;
            const selectedStatut = statutFilter.value;
            const rows = utilisateursTable.querySelectorAll("tbody tr");

            rows.forEach((row) => {
                const userData = {
                    text: row.textContent.toLowerCase(),
                    role: row.dataset.role,
                    statut: row.dataset.statut,
                };

                const matchesSearch =
                    !searchTerm || userData.text.includes(searchTerm);
                const matchesRole =
                    !selectedRole || userData.role === selectedRole;
                const matchesStatut =
                    !selectedStatut || userData.statut === selectedStatut;

                row.style.display =
                    matchesSearch && matchesRole && matchesStatut ? "" : "none";
            });
        }

        // Event listeners pour les filtres
        searchInput.addEventListener("input", filterTable);
        roleFilter.addEventListener("change", filterTable);
        statutFilter.addEventListener("change", filterTable);

        // Afficher/masquer le mot de passe
        window.togglePassword = function () {
            const passwordField = document.getElementById("password");
            const toggleIcon = document.getElementById("togglePasswordIcon");

            if (passwordField.type === "password") {
                passwordField.type = "text";
                toggleIcon.className = "bi bi-eye-slash";
            } else {
                passwordField.type = "password";
                toggleIcon.className = "bi bi-eye";
            }
        };

        // Modifier utilisateur
        window.modifierUtilisateur = async function (userId) {
            try {
                const response = await fetch(`/api/utilisateurs/${userId}`);
                const data = await response.json();

                if (data.success) {
                    const user = data.utilisateur;

                    // Remplir le formulaire
                    document.getElementById("utilisateurId").value = user.id;
                    document.getElementById("username").value = user.username;
                    document.getElementById("email").value = user.email;
                    document.getElementById("nom_complet").value =
                        user.nom_complet;
                    document.getElementById("telephone").value =
                        user.telephone || "";
                    document.getElementById("role").value = user.role;
                    document.getElementById("statut").value = user.statut;

                    // Ajuster l'interface pour la modification
                    document.getElementById("modalTitle").innerHTML =
                        '<i class="bi bi-pencil text-warning"></i> Modifier Utilisateur';
                    document.getElementById("passwordRequired").style.display =
                        "none";
                    document.getElementById(
                        "confirmPasswordRequired"
                    ).style.display = "none";
                    document.getElementById("passwordHelp").style.display =
                        "block";

                    isEditMode = true;
                    currentUserId = userId;

                    // Afficher le modal
                    new bootstrap.Modal(
                        document.getElementById("nouveauUtilisateurModal")
                    ).show();
                } else {
                    showAlert(
                        "Erreur lors du chargement des données utilisateur",
                        "danger"
                    );
                }
            } catch (error) {
                console.error("Erreur:", error);
                showAlert(
                    "Erreur lors du chargement des données utilisateur",
                    "danger"
                );
            }
        };

        // Supprimer utilisateur
        window.supprimerUtilisateur = function (userId, username) {
            document.getElementById("deleteUserName").textContent = username;
            document.getElementById("confirmDeleteBtn").onclick = () =>
                confirmerSuppression(userId);
            new bootstrap.Modal(
                document.getElementById("confirmDeleteModal")
            ).show();
        };

        async function confirmerSuppression(userId) {
            try {
                const response = await fetch(`/api/utilisateurs/${userId}`, {
                    method: "DELETE",
                });
                const data = await response.json();

                if (data.success) {
                    showAlert("Utilisateur supprimé avec succès", "success");
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(
                        data.message || "Erreur lors de la suppression",
                        "danger"
                    );
                }

                bootstrap.Modal.getInstance(
                    document.getElementById("confirmDeleteModal")
                ).hide();
            } catch (error) {
                console.error("Erreur:", error);
                showAlert("Erreur lors de la suppression", "danger");
            }
        }

        // Soumission du formulaire
        utilisateurForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = new FormData(utilisateurForm);
            const userData = Object.fromEntries(formData.entries());

            // Validation des mots de passe
            if (!isEditMode || userData.password) {
                if (userData.password !== userData.confirmPassword) {
                    showAlert(
                        "Les mots de passe ne correspondent pas",
                        "danger"
                    );
                    return;
                }
                if (userData.password.length < 6) {
                    showAlert(
                        "Le mot de passe doit contenir au moins 6 caractères",
                        "danger"
                    );
                    return;
                }
            }

            // Supprimer la confirmation du mot de passe
            delete userData.confirmPassword;

            // Si pas de mot de passe en mode édition, le supprimer
            if (isEditMode && !userData.password) {
                delete userData.password;
            }

            try {
                const url = isEditMode
                    ? `/api/utilisateurs/${currentUserId}`
                    : "/api/utilisateurs";
                const method = isEditMode ? "PUT" : "POST";

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(userData),
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(
                        data.message || "Utilisateur sauvegardé avec succès",
                        "success"
                    );
                    bootstrap.Modal.getInstance(
                        document.getElementById("nouveauUtilisateurModal")
                    ).hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(
                        data.message || "Erreur lors de la sauvegarde",
                        "danger"
                    );
                }
            } catch (error) {
                console.error("Erreur:", error);
                showAlert("Erreur lors de la sauvegarde", "danger");
            }
        });

        // Réinitialiser le formulaire à la fermeture du modal
        document
            .getElementById("nouveauUtilisateurModal")
            .addEventListener("hidden.bs.modal", function () {
                utilisateurForm.reset();
                document.getElementById("modalTitle").innerHTML =
                    '<i class="bi bi-plus-circle text-primary"></i> Nouvel Utilisateur';
                document.getElementById("passwordRequired").style.display =
                    "inline";
                document.getElementById(
                    "confirmPasswordRequired"
                ).style.display = "inline";
                document.getElementById("passwordHelp").style.display = "none";
                isEditMode = false;
                currentUserId = null;
            });

        // Fonction d'affichage des alertes
        function showAlert(message, type) {
            // Supprimer les alertes existantes
            const existingAlerts = document.querySelectorAll(".alert");
            existingAlerts.forEach((alert) => alert.remove());

            // Créer la nouvelle alerte
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

            // Insérer l'alerte au début du contenu
            const container = document.querySelector(".container-fluid");
            container.insertBefore(alertDiv, container.firstChild);

            // Auto-suppression après 5 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    });
</script>

{% endblock %}
